// Last time updated: 2016-09-03 8:59:13 PM UTC

// _____________________
// RTCMultiConnection-v3

// Open-Sourced: https://github.com/muaz-khan/RTCMultiConnection

// --------------------------------------------------
// Muaz Khan     - www.MuazKhan.com
// MIT License   - www.WebRTC-Experiment.com/licence
// --------------------------------------------------

'use strict';

"use strict";!function(){function a(a,d){function j(a){s.deletePeer(a)}function l(a){if(s.socketAutoReConnect=!0,s.socket)return void(a&&a(s.socket));if("undefined"==typeof b)if("undefined"!=typeof FirebaseConnection)window.SocketConnection=FirebaseConnection;else{if("undefined"==typeof PubNubConnection)throw"SocketConnection.js seems missed.";window.SocketConnection=PubNubConnection}new b(s,function(b){a&&a(s.socket)})}function o(a,b){s.closeBeforeUnload&&(s.isInitiator===!0&&s.dontMakeMeModerator(),s.peers.getAllParticipants().forEach(function(a){t.onNegotiationNeeded({userLeft:!0},a),s.peers[a]&&s.peers[a].peer&&s.peers[a].peer.close(),delete s.peers[a]}),b||s.closeSocket(),s.broadcasters=[],s.isInitiator=!1)}function p(a,b){return a?(b.audio&&a.getAudioTracks().forEach(function(a){a.applyConstraints(b.audio)}),void(b.video&&a.getVideoTracks().forEach(function(a){a.applyConstraints(b.video)}))):void(s.enableLogs&&console.error("No stream to applyConstraints."))}function q(a,b,c){return b?void t.replaceTrack(a,b,c):void s.peers.getAllParticipants().forEach(function(b){t.replaceTrack(a,b,c)})}function r(){if(s.isInitiator&&!s.session.oneway&&!s.session.broadcast&&"many-to-many"===s.direction){var a=s.broadcasters[0],b=[];s.broadcasters.forEach(function(c){c!==a&&b.push(c)}),s.autoCloseEntireSession||s.shiftModerationControl(a,b,!0)}}d=d||{useDefaultDevices:!0};var s=this;s.channel=s.sessionid=(a||location.href.replace(/\/|:|#|\?|\$|\^|%|\.|`|~|!|\+|@|\[|\||]|\|*. /g,"").split("\n").join("").split("\r").join(""))+"";var t=new c(s);t.onGettingLocalMedia=function(a){a.type="local",s.setStreamEndHandler(a),h(a,function(b){b.id=a.streamid,b.muted=!0,b.volume=0,s.attachStreams.indexOf(a)===-1&&s.attachStreams.push(a),"undefined"!=typeof R&&R.setHandlers(a,!0,s),s.streamEvents[a.streamid]={stream:a,type:"local",mediaElement:b,userid:s.userid,extra:s.extra,streamid:a.streamid,blobURL:b.src||URL.createObjectURL(a),isAudioMuted:!0},e(s,s.streamEvents[a.streamid]),f(s,s.streamEvents[a.streamid]),s.onstream(s.streamEvents[a.streamid])},s)},t.onGettingRemoteMedia=function(a,b){a.type="remote",s.setStreamEndHandler(a,"remote-stream"),h(a,function(c){c.id=a.streamid,"undefined"!=typeof R&&R.setHandlers(a,!1,s),s.streamEvents[a.streamid]={stream:a,type:"remote",userid:b,extra:s.peers[b]?s.peers[b].extra:{},mediaElement:c,streamid:a.streamid,blobURL:c.src||URL.createObjectURL(a)},f(s,s.streamEvents[a.streamid]),s.onstream(s.streamEvents[a.streamid])},s)},t.onRemovingRemoteMedia=function(a,b){var c=s.streamEvents[a.streamid];c||(c={stream:a,type:"remote",userid:b,extra:s.peers[b]?s.peers[b].extra:{},streamid:a.streamid,mediaElement:s.streamEvents[a.streamid]?s.streamEvents[a.streamid].mediaElement:null}),s.onstreamended(c),delete s.streamEvents[a.streamid]},t.onNegotiationNeeded=function(a,b,c){l(function(){s.socket.emit(s.socketMessageEvent,"password"in a?a:{remoteUserId:a.remoteUserId||b,message:a,sender:s.userid},c||function(){})})},t.onUserLeft=j,t.disconnectWith=function(a,b){s.socket&&s.socket.emit("disconnect-with",a,b||function(){}),s.deletePeer(a)},s.broadcasters=[],s.socketOptions={transport:"polling"},s.openOrJoin=function(a,b){s.checkPresence(a,function(c,d){if("function"==typeof b&&(b(c,d),b=null),c){s.sessionid=d;var e=!1,f=!1,g=!!s.session.oneway,h=k(s.session);f={OfferToReceiveAudio:s.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:s.sdpConstraints.mandatory.OfferToReceiveVideo},e={OfferToReceiveAudio:g?!!s.session.audio:s.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:g?!!s.session.video||!!s.session.screen:s.sdpConstraints.mandatory.OfferToReceiveVideo};var i={remoteUserId:s.sessionid,message:{newParticipationRequest:!0,isOneWay:g,isDataOnly:h,localPeerSdpConstraints:e,remotePeerSdpConstraints:f},sender:s.userid,password:b||!1};return void t.onNegotiationNeeded(i)}s.userid;s.userid=s.sessionid=a||s.sessionid,s.userid+="",s.socket.emit("changed-uuid",s.userid),b&&s.socket.emit("set-password",b),s.isInitiator=!0,k(s.session)||s.captureUserMedia()})},s.open=function(a,b){s.userid;return s.userid=s.sessionid=a||s.sessionid,s.userid+="",s.isInitiator=!0,l(function(){s.socket.emit("changed-uuid",s.userid),1==b&&s.becomePublicModerator()}),k(s.session)?void("function"==typeof b&&b()):void s.captureUserMedia("function"==typeof b?b:null)},s.becomePublicModerator=function(){s.isInitiator&&s.socket.emit("become-a-public-moderator")},s.dontMakeMeModerator=function(){s.socket.emit("dont-make-me-moderator")},s.deletePeer=function(a){if(a){if(s.onleave({userid:a,extra:s.peers[a]?s.peers[a].extra:{}}),s.peers[a]){s.peers[a].streams.forEach(function(a){a.stop()});var b=s.peers[a].peer;if(b&&"closed"!==b.iceConnectionState)try{b.close()}catch(c){}s.peers[a]&&(s.peers[a].peer=null,delete s.peers[a])}if(s.broadcasters.indexOf(a)!==-1){var d=[];s.broadcasters.forEach(function(b){b!==a&&d.push(b)}),s.broadcasters=d,r()}}},s.rejoin=function(a){if(!s.isInitiator&&a&&Object.keys(a).length){var b={};s.peers[a.remoteUserId]&&(b=s.peers[a.remoteUserId].extra,s.deletePeer(a.remoteUserId)),a&&a.remoteUserId&&(s.join(a.remoteUserId),s.onReConnecting({userid:a.remoteUserId,extra:b}))}},s.join=s.connect=function(a,b){s.sessionid=!!a&&(a.sessionid||a.remoteUserId||a)||s.sessionid,s.sessionid+="";var c=!1,d=!1,e=!1,f=!1;if(a&&a.session||!a||"string"==typeof a){var g=a?a.session||s.session:s.session;e=!!g.oneway,f=k(g),d={OfferToReceiveAudio:s.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:s.sdpConstraints.mandatory.OfferToReceiveVideo},c={OfferToReceiveAudio:e?!!s.session.audio:s.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:e?!!s.session.video||!!s.session.screen:s.sdpConstraints.mandatory.OfferToReceiveVideo}}b=b||{};var h=function(){};"function"==typeof b&&(h=b,b={}),"undefined"!=typeof b.localPeerSdpConstraints&&(c=b.localPeerSdpConstraints),"undefined"!=typeof b.remotePeerSdpConstraints&&(d=b.remotePeerSdpConstraints),"undefined"!=typeof b.isOneWay&&(e=b.isOneWay),"undefined"!=typeof b.isDataOnly&&(f=b.isDataOnly);var i={remoteUserId:s.sessionid,message:{newParticipationRequest:!0,isOneWay:e,isDataOnly:f,localPeerSdpConstraints:c,remotePeerSdpConstraints:d},sender:s.userid,password:!1};return l(function(){s.peers[s.sessionid]||(t.onNegotiationNeeded(i),h())}),i},s.connectWithAllParticipants=function(a){t.onNegotiationNeeded("connectWithAllParticipants",a||s.sessionid)},s.removeFromBroadcastersList=function(a){t.onNegotiationNeeded("removeFromBroadcastersList",a||s.sessionid),s.peers.getAllParticipants(a||s.sessionid).forEach(function(a){t.onNegotiationNeeded("dropPeerConnection",a),s.deletePeer(a)}),s.attachStreams.forEach(function(a){a.stop()})},s.getUserMedia=s.captureUserMedia=function(a,b){a=a||function(){};var c=b||s.session;return s.dontCaptureUserMedia||k(c)?void a():void((c.audio||c.video||c.screen)&&(c.screen?s.getScreenConstraints(function(d,e){if(d)throw d;s.invokeGetUserMedia({audio:!!m(s)&&n(e),video:e,isScreen:!0},function(d){if((c.audio||c.video)&&!m(s)){var e={};for(var f in c)"screen"!==f&&(e[f]=c[f]);return void s.invokeGetUserMedia(b,a,e)}a(d)})}):(c.audio||c.video)&&s.invokeGetUserMedia(b,a,c)))},s.closeBeforeUnload=!0,window.addEventListener("beforeunload",o,!1),s.userid=g(),s.changeUserId=function(a,b){s.userid=a||g(),s.socket.emit("changed-uuid",s.userid,b||function(){})},s.extra={},s.attachStreams=[],s.session={audio:!0,video:!0},s.enableFileSharing=!1,s.bandwidth={screen:512,audio:128,video:512},s.codecs={audio:"opus",video:"VP9"},s.processSdp=function(a){return B||x?a:(a=M.setApplicationSpecificBandwidth(a,s.bandwidth,!!s.session.screen),a=M.setVideoBitrates(a,{min:8*s.bandwidth.video*1024,max:8*s.bandwidth.video*1024}),a=M.setOpusAttributes(a,{maxaveragebitrate:8*s.bandwidth.audio*1024,maxplaybackrate:8*s.bandwidth.audio*1024,stereo:1,maxptime:3}),"VP9"===s.codecs.video&&(a=M.preferVP9(a)),"H264"===s.codecs.video&&(a=M.removeVPX(a)),"G722"===s.codecs.audio&&(a=M.removeNonG722(a)),a)},"undefined"!=typeof M&&(s.BandwidthHandler=s.CodecsHandler=M),s.mediaConstraints={audio:{mandatory:{},optional:[{bandwidth:8*s.bandwidth.audio*1024||1048576}]},video:{mandatory:{},optional:[{bandwidth:8*s.bandwidth.video*1024||1048576},{facingMode:"user"}]}},x&&(s.mediaConstraints={audio:!0,video:!0}),d.useDefaultDevices||B||DetectRTC.load(function(){var a,b;if(DetectRTC.MediaDevices.forEach(function(c){"audioinput"===c.kind&&s.mediaConstraints.audio!==!1&&(a=c),"videoinput"===c.kind&&s.mediaConstraints.video!==!1&&(b=c)}),a){if(x)return void(s.mediaConstraints.audio!==!0?s.mediaConstraints.audio.deviceId=a.id:s.mediaConstraints.audio={deviceId:a.id});1==s.mediaConstraints.audio&&(s.mediaConstraints.audio={mandatory:{},optional:[]}),s.mediaConstraints.audio.optional||(s.mediaConstraints.audio.optional=[]);var c=[{sourceId:a.id}];s.mediaConstraints.audio.optional=c.concat(s.mediaConstraints.audio.optional)}if(b){if(x)return void(s.mediaConstraints.video!==!0?s.mediaConstraints.video.deviceId=b.id:s.mediaConstraints.video={deviceId:b.id});1==s.mediaConstraints.video&&(s.mediaConstraints.video={mandatory:{},optional:[]}),s.mediaConstraints.video.optional||(s.mediaConstraints.video.optional=[]);var c=[{sourceId:b.id}];s.mediaConstraints.video.optional=c.concat(s.mediaConstraints.video.optional)}}),s.sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[{VoiceActivityDetection:!1}]},s.optionalArgument={optional:[{DtlsSrtpKeyAgreement:!0},{googImprovedWifiBwe:!0},{googScreencastMinBitrate:300},{googIPv6:!0},{googDscp:!0},{googCpuUnderuseThreshold:55},{googCpuOveruseThreshold:85},{googSuspendBelowMinBitrate:!0},{googCpuOveruseDetection:!0}],mandatory:{}},s.iceServers=P.getIceServers(s),s.candidates={host:!0,stun:!0,turn:!0},s.iceProtocols={tcp:!0,udp:!0},s.onopen=function(a){s.enableLogs&&console.info("Data connection has been opened between you & ",a.userid)},s.onclose=function(a){s.enableLogs&&console.warn("Data connection has been closed between you & ",a.userid)},s.onerror=function(a){s.enableLogs&&console.error(a.userid,"data-error",a)},s.onmessage=function(a){s.enableLogs&&console.debug("data-message",a.userid,a.data)},s.send=function(a,b){s.peers.send(a,b)},s.close=s.disconnect=s.leave=function(){o(!1,!0)},s.closeEntireSession=function(a){a=a||function(){},s.socket.emit("close-entire-session",function b(){return s.getAllParticipants().length?void setTimeout(b,100):(s.onEntireSessionClosed({sessionid:s.sessionid,userid:s.userid,extra:s.extra}),void s.changeUserId(null,function(){s.close(),a()}))})},s.onEntireSessionClosed=function(a){s.enableLogs&&console.info("Entire session is closed: ",a.sessionid,a.extra)},s.onstream=function(a){var b=s.videosContainer;b.insertBefore(a.mediaElement,b.firstChild),a.mediaElement.play(),setTimeout(function(){a.mediaElement.play()},5e3)},s.onstreamended=function(a){a.mediaElement||(a.mediaElement=document.getElementById(a.streamid)),a.mediaElement&&a.mediaElement.parentNode&&a.mediaElement.parentNode.removeChild(a.mediaElement)},s.direction="many-to-many",s.removeStream=function(a){var b;return s.attachStreams.forEach(function(c){c.id===a&&(b=c)}),b?(s.peers.getAllParticipants().forEach(function(a){var c=s.peers[a];try{c.peer.removeStream(b)}catch(d){}}),void s.renegotiate()):void console.warn("No such stream exists.",a)},s.addStream=function(a,b){function c(c){a.streamCallback&&a.streamCallback(c),s.renegotiate(b)}return a.getAudioTracks?(s.attachStreams.indexOf(a)===-1&&(a.streamid||(a.streamid=a.id),s.attachStreams.push(a)),void s.renegotiate(b)):k(a)?void s.renegotiate(b):void((a.audio||a.video||a.screen)&&(a.screen?s.getScreenConstraints(function(b,d){return b?"PermissionDeniedError"===b?(a.streamCallback&&a.streamCallback(null),void(s.enableLogs&&console.error("User rejected to share his screen."))):alert(b):void s.invokeGetUserMedia({audio:!!m(s)&&n(d),video:d,isScreen:!0},!a.audio&&!a.video||m(s)?c:s.invokeGetUserMedia(null,c))}):(a.audio||a.video)&&s.invokeGetUserMedia(null,c)))},s.invokeGetUserMedia=function(a,b,c){c||(c=s.session),a||(a=s.mediaConstraints),v({onGettingLocalMedia:function(c){var d=a.video;d&&(d.mediaSource||d.mozMediaSource?c.isScreen=!0:d.mandatory&&d.mandatory.chromeMediaSource&&(c.isScreen=!0)),c.isScreen||(c.isVideo=c.getVideoTracks().length,c.isAudio=!c.isVideo&&c.getAudioTracks().length),t.onGettingLocalMedia(c),b&&b(c)},onLocalMediaError:function(a,b){t.onLocalMediaError(a,b)},localMediaConstraints:a||{audio:!!c.audio&&a.audio,video:!!c.video&&a.video}})},s.applyConstraints=function(a,b){if(!L||!L.prototype.applyConstraints)return void alert("track.applyConstraints is NOT supported in your browser.");if(b){var c;return s.streamEvents[b]&&(c=s.streamEvents[b].stream),void p(c,a)}s.attachStreams.forEach(function(b){p(b,a)})},s.replaceTrack=function(a,b,c){function d(d){s.replaceTrack(d,b,c||a.video||a.screen)}if(a=a||{},!H.prototype.getSenders)return void s.addStream(a);if(a instanceof L)return void q(a,b,c);if(a instanceof G)return a.getVideoTracks().length&&q(a.getVideoTracks()[0],b,!0),void(a.getAudioTracks().length&&q(a.getAudioTracks()[0],b,!1));if(k(a))throw"connection.replaceTrack requires audio and/or video and/or screen.";(a.audio||a.video||a.screen)&&(a.screen?s.getScreenConstraints(function(b,c){return b?alert(b):void s.invokeGetUserMedia({audio:!!m(s)&&n(c),video:c,isScreen:!0},!a.audio&&!a.video||m(s)?d:s.invokeGetUserMedia(null,d))}):(a.audio||a.video)&&s.invokeGetUserMedia(null,d))},s.resetTrack=function(a,b){a||(a=s.getAllParticipants()),"string"==typeof a&&(a=[a]),a.forEach(function(a){var c=s.peers[a].peer;"undefined"!=typeof b&&b!==!0||!c.lastVideoTrack||s.replaceTrack(c.lastVideoTrack,a,!0),"undefined"!=typeof b&&b!==!1||!c.lastAudioTrack||s.replaceTrack(c.lastAudioTrack,a,!1)})},s.renegotiate=function(a){return a?void t.renegotiatePeer(a):void s.peers.getAllParticipants().forEach(function(a){t.renegotiatePeer(a)})},s.setStreamEndHandler=function(a,b){if(a&&a.addEventListener&&(b=!!b,!a.alreadySetEndHandler)){a.alreadySetEndHandler=!0;var c="ended";"oninactive"in a&&(c="inactive"),a.addEventListener(c,function(){a.idInstance&&Q.remove(a.idInstance),b||delete s.attachStreams[s.attachStreams.indexOf(a)];var c=s.streamEvents[a.streamid];c||(c={stream:a,streamid:a.streamid,type:b?"remote":"local",userid:s.userid,extra:s.extra,mediaElement:s.streamEvents[a.streamid]?s.streamEvents[a.streamid].mediaElement:null}),c.userid===s.userid&&"remote"===c.type||(s.onstreamended(c),delete s.streamEvents[a.streamid])},!1)}},s.onMediaError=function(a,b){s.enableLogs&&console.error(a,b)},s.addNewBroadcaster=function(a,b){s.broadcasters.length&&setTimeout(function(){t.connectNewParticipantWithAllBroadcasters(a,b,s.broadcasters.join("|-,-|"))},1e4),s.session.oneway||s.session.broadcast||"many-to-many"!==s.direction||s.broadcasters.indexOf(a)!==-1||(s.broadcasters.push(a),r())},s.autoCloseEntireSession=!1,s.filesContainer=s.videosContainer=document.body||document.documentElement,s.isInitiator=!1,s.shareFile=t.shareFile,"undefined"!=typeof FileProgressBarHandler&&FileProgressBarHandler.handle(s),"undefined"!=typeof TranslationHandler&&TranslationHandler.handle(s),s.token=g,s.onNewParticipant=function(a,b){s.acceptParticipationRequest(a,b)},s.acceptParticipationRequest=function(a,b){b.successCallback&&(b.successCallback(),delete b.successCallback),t.createNewPeer(a,b)},s.onShiftedModerationControl=function(a,b){s.acceptModerationControl(a,b)},s.acceptModerationControl=function(a,b){s.isInitiator=!0,s.broadcasters=b,s.peers.getAllParticipants().forEach(function(b){t.onNegotiationNeeded({changedUUID:a,oldUUID:s.userid,newUUID:a},b)}),s.userid=a,s.socket.emit("changed-uuid",s.userid)},s.shiftModerationControl=function(a,b,c){t.onNegotiationNeeded({shiftedModerationControl:!0,broadcasters:b,firedOnLeave:!!c},a)},"undefined"!=typeof R&&(s.StreamsHandler=R),s.onleave=function(a){},s.invokeSelectFileDialog=function(a){var b=new FileSelector;b.selectSingleFile(a)},s.getPublicModerators=function(a,b){"function"==typeof a&&(b=a),l(function(){s.socket.emit("get-public-moderators","string"==typeof a?a:"",b)})},s.onmute=function(a){a&&a.mediaElement&&("both"===a.muteType||"video"===a.muteType?(a.mediaElement.src=null,a.mediaElement.pause(),a.mediaElement.poster=a.snapshot||"https://cdn.webrtc-experiment.com/images/muted.png"):"audio"===a.muteType&&(a.mediaElement.muted=!0))},s.onunmute=function(a){a&&a.mediaElement&&a.stream&&("both"===a.unmuteType||"video"===a.unmuteType?(a.mediaElement.poster=null,a.mediaElement.src=URL.createObjectURL(a.stream),a.mediaElement.play()):"audio"===a.unmuteType&&(a.mediaElement.muted=!1))},s.onExtraDataUpdated=function(a){a.status="online",s.onUserStatusChanged(a,!0)},s.onJoinWithPassword=function(a){console.warn(a,"is password protected. Please join with password.")},s.onInvalidPassword=function(a,b){console.warn(a,"is password protected. Please join with valid password. Your old password",b,"is wrong.")},s.onPasswordMaxTriesOver=function(a){console.warn(a,"is password protected. Your max password tries exceeded the limit.")},s.getAllParticipants=function(a){return s.peers.getAllParticipants(a)},"undefined"!=typeof R&&(R.onSyncNeeded=function(a,b,c){s.peers.getAllParticipants().forEach(function(d){t.onNegotiationNeeded({streamid:a,action:b,streamSyncNeeded:!0,type:c||"both"},d)})}),s.connectSocket=function(a){l(a)},s.socketAutoReConnect=!0,s.closeSocket=function(){try{io.sockets={}}catch(a){}s.socket&&(s.socketAutoReConnect=!1,"function"==typeof s.socket.disconnect&&s.socket.disconnect(),s.socket=null)},s.getSocket=function(a){return s.socket?a&&a(s.socket):l(a),s.socket},s.getRemoteStreams=t.getRemoteStreams;var u=["selectFirst","selectAll","forEach"];if(s.streamEvents={selectFirst:function(a){if(!a){var b;for(var c in s.streamEvents)u.indexOf(c)!==-1||b||(b=s.streamEvents[c]);return b}},selectAll:function(){}},s.socketURL="/",s.socketMessageEvent="RTCMultiConnection-Message",s.socketCustomEvent="RTCMultiConnection-Custom-Message",s.DetectRTC=DetectRTC,s.setCustomSocketEvent=function(a){a&&(s.socketCustomEvent=a),s.socket&&s.socket.emit("set-custom-socket-event-listener",s.socketCustomEvent)},s.getNumberOfBroadcastViewers=function(a,b){s.socket&&a&&b&&s.socket.emit("get-number-of-users-in-specific-broadcast",a,b)},s.onNumberOfBroadcastViewersUpdated=function(a){s.enableLogs&&s.isInitiator&&console.info("Number of broadcast (",a.broadcastId,") viewers",a.numberOfBroadcastViewers)},s.onUserStatusChanged=function(a,b){s.enableLogs&&!b&&console.info(a.userid,a.status)},s.getUserMediaHandler=v,s.multiPeersHandler=t,s.enableLogs=!0,s.setCustomSocketHandler=function(a){"undefined"!=typeof b&&(b=a)},s.chunkSize=65e3,s.maxParticipantsAllowed=1e3,s.disconnectWith=t.disconnectWith,s.checkPresence=function(a,b){return s.socket?void s.socket.emit("check-presence",(a||s.sessionid)+"",b):void s.connectSocket(function(){s.checkPresence(a,b)})},s.onReadyForOffer=function(a,b){s.multiPeersHandler.createNewPeer(a,b)},s.setUserPreferences=function(a){return s.dontAttachStream&&(a.dontAttachLocalStream=!0),s.dontGetRemoteStream&&(a.dontGetRemoteStream=!0),a},s.updateExtraData=function(){s.socket.emit("extra-data-updated",s.extra)},s.enableScalableBroadcast=!1,s.maxRelayLimitPerUser=3,s.dontCaptureUserMedia=!1,s.dontAttachStream=!1,s.dontGetRemoteStream=!1,s.onReConnecting=function(a){s.enableLogs&&console.info("ReConnecting with",a.userid,"...")},s.beforeAddingStream=function(a){return a},s.beforeRemovingStream=function(a){return a},"undefined"!=typeof isChromeExtensionAvailable&&(s.checkIfChromeExtensionAvailable=isChromeExtensionAvailable),"undefined"!=typeof isFirefoxExtensionAvailable&&(s.checkIfChromeExtensionAvailable=isFirefoxExtensionAvailable),"undefined"!=typeof getChromeExtensionStatus&&(s.getChromeExtensionStatus=getChromeExtensionStatus),s.getScreenConstraints=function(a,b){m(s,b)&&(b=!0),getScreenConstraints(function(b,c){b||(c=s.modifyScreenConstraints(c),a(b,c))},b)},s.modifyScreenConstraints=function(a){return a},s.onPeerStateChanged=function(a){s.enableLogs&&a.iceConnectionState.search(/closed|failed/gi)!==-1&&console.error("Peer connection is closed between you & ",a.userid,a.extra,"state:",a.iceConnectionState)},s.isOnline=!0,i("online",function(){s.isOnline=!0}),i("offline",function(){s.isOnline=!1}),s.isLowBandwidth=!1,navigator&&navigator.connection&&navigator.connection.type&&(s.isLowBandwidth=navigator.connection.type.toString().toLowerCase().search(/wifi|cell/g)!==-1,s.isLowBandwidth)){if(s.bandwidth={audio:30,video:30,screen:30},s.mediaConstraints.audio&&s.mediaConstraints.audio.optional&&s.mediaConstraints.audio.optional.length){var w=[];s.mediaConstraints.audio.optional.forEach(function(a){"undefined"==typeof a.bandwidth&&w.push(a)}),s.mediaConstraints.audio.optional=w}if(s.mediaConstraints.video&&s.mediaConstraints.video.optional&&s.mediaConstraints.video.optional.length){var w=[];s.mediaConstraints.video.optional.forEach(function(a){"undefined"==typeof a.bandwidth&&w.push(a)}),s.mediaConstraints.video.optional=w}}s.getExtraData=function(a){if(!a)throw"remoteUserId is required.";return s.peers[a]?s.peers[a].extra:{}},d.autoOpenOrJoin&&s.openOrJoin(s.sessionid),s.onUserIdAlreadyTaken=function(a,b){s.enableLogs&&console.warn("Userid already taken.",a,"Your new userid:",b),s.join(a)},s.trickleIce=!0}function b(a,b){var c="";c+="?userid="+a.userid,c+="&msgEvent="+a.socketMessageEvent,c+="&socketCustomEvent="+a.socketCustomEvent,a.enableScalableBroadcast&&(c+="&enableScalableBroadcast=true",c+="&maxRelayLimitPerUser="+(a.maxRelayLimitPerUser||2)),a.socketCustomParameters&&(c+=a.socketCustomParameters);try{io.sockets={}}catch(d){}try{a.socket=io((a.socketURL||"/")+c)}catch(d){a.socket=io.connect((a.socketURL||"/")+c,a.socketOptions)}var e=a.multiPeersHandler;a.socket.on("extra-data-updated",function(b,c){a.peers[b]&&(a.peers[b].extra=c,a.onExtraDataUpdated({userid:b,extra:c}))}),a.socket.on(a.socketMessageEvent,function(b){if(b.remoteUserId==a.userid){if(a.peers[b.sender]&&a.peers[b.sender].extra!=b.message.extra&&(a.peers[b.sender].extra=b.extra,a.onExtraDataUpdated({userid:b.sender,extra:b.extra})),b.message.streamSyncNeeded&&a.peers[b.sender]){var c=a.streamEvents[b.message.streamid];if(!c||!c.stream)return;var d=b.message.action;if("ended"===d||"stream-removed"===d)return void a.onstreamended(c);var f="both"!=b.message.type?b.message.type:null;return void c.stream[d](f)}if("connectWithAllParticipants"===b.message)return a.broadcasters.indexOf(b.sender)===-1&&a.broadcasters.push(b.sender),void e.onNegotiationNeeded({allParticipants:a.getAllParticipants(b.sender)},b.sender);if("removeFromBroadcastersList"===b.message)return void(a.broadcasters.indexOf(b.sender)!==-1&&(delete a.broadcasters[a.broadcasters.indexOf(b.sender)],a.broadcasters=j(a.broadcasters)));if("dropPeerConnection"===b.message)return void a.deletePeer(b.sender);if(b.message.allParticipants)return b.message.allParticipants.indexOf(b.sender)===-1&&b.message.allParticipants.push(b.sender),void b.message.allParticipants.forEach(function(b){e[a.peers[b]?"renegotiatePeer":"createNewPeer"](b,{localPeerSdpConstraints:{OfferToReceiveAudio:a.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:a.sdpConstraints.mandatory.OfferToReceiveVideo},remotePeerSdpConstraints:{OfferToReceiveAudio:a.session.oneway?!!a.session.audio:a.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:a.session.oneway?!!a.session.video||!!a.session.screen:a.sdpConstraints.mandatory.OfferToReceiveVideo},isOneWay:!!a.session.oneway||"one-way"===a.direction,isDataOnly:k(a.session)})});if(b.message.newParticipant){if(b.message.newParticipant==a.userid)return;if(a.peers[b.message.newParticipant])return;return void e.createNewPeer(b.message.newParticipant,b.message.userPreferences||{localPeerSdpConstraints:{OfferToReceiveAudio:a.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:a.sdpConstraints.mandatory.OfferToReceiveVideo},remotePeerSdpConstraints:{OfferToReceiveAudio:a.session.oneway?!!a.session.audio:a.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:a.session.oneway?!!a.session.video||!!a.session.screen:a.sdpConstraints.mandatory.OfferToReceiveVideo},isOneWay:!!a.session.oneway||"one-way"===a.direction,isDataOnly:k(a.session)})}if((b.message.readyForOffer||b.message.addMeAsBroadcaster)&&a.addNewBroadcaster(b.sender),b.message.newParticipationRequest&&b.sender!==a.userid){a.peers[b.sender]&&a.deletePeer(b.sender);var g={extra:b.extra||{},localPeerSdpConstraints:b.message.remotePeerSdpConstraints||{OfferToReceiveAudio:a.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:a.sdpConstraints.mandatory.OfferToReceiveVideo},remotePeerSdpConstraints:b.message.localPeerSdpConstraints||{OfferToReceiveAudio:a.session.oneway?!!a.session.audio:a.sdpConstraints.mandatory.OfferToReceiveAudio,OfferToReceiveVideo:a.session.oneway?!!a.session.video||!!a.session.screen:a.sdpConstraints.mandatory.OfferToReceiveVideo},isOneWay:"undefined"!=typeof b.message.isOneWay?b.message.isOneWay:!!a.session.oneway||"one-way"===a.direction,isDataOnly:"undefined"!=typeof b.message.isDataOnly?b.message.isDataOnly:k(a.session),dontGetRemoteStream:"undefined"!=typeof b.message.isOneWay?b.message.isOneWay:!!a.session.oneway||"one-way"===a.direction,dontAttachLocalStream:!!b.message.dontGetRemoteStream,connectionDescription:b,successCallback:function(){("undefined"!=typeof b.message.isOneWay?b.message.isOneWay:!!a.session.oneway||"one-way"===a.direction)&&a.addNewBroadcaster(b.sender,g),(a.session.oneway||"one-way"===a.direction||k(a.session))&&a.addNewBroadcaster(b.sender,g)}};return void a.onNewParticipant(b.sender,g)}return b.message.shiftedModerationControl?void a.onShiftedModerationControl(b.sender,b.message.broadcasters):(b.message.changedUUID&&a.peers[b.message.oldUUID]&&(a.peers[b.message.newUUID]=a.peers[b.message.oldUUID],delete a.peers[b.message.oldUUID]),b.message.userLeft?(e.onUserLeft(b.sender),void(b.message.autoCloseEntireSession&&a.leave())):void e.addNegotiatedMessage(b.message,b.sender))}}),a.socket.on("user-left",function(b){onUserLeft(b),a.onUserStatusChanged({userid:b,status:"offline",extra:a.peers[b]?a.peers[b].extra||{}:{}}),a.onleave({userid:b,extra:{}})}),a.socket.on("connect",function(){return a.socketAutoReConnect?(a.enableLogs&&console.info("socket.io connection is opened."),void setTimeout(function(){a.socket.emit("extra-data-updated",a.extra),b&&b(a.socket)},1e3)):void(a.socket=null)}),a.socket.on("disconnect",function(){return a.socketAutoReConnect?void(a.enableLogs&&(console.info("socket.io connection is closed"),console.warn("socket.io reconnecting"))):void(a.socket=null)}),a.socket.on("join-with-password",function(b){a.onJoinWithPassword(b)}),a.socket.on("invalid-password",function(b,c){a.onInvalidPassword(b,c)}),a.socket.on("password-max-tries-over",function(b){a.onPasswordMaxTriesOver(b)}),a.socket.on("user-disconnected",function(b){b!==a.userid&&(a.onUserStatusChanged({userid:b,status:"offline",extra:a.peers[b]?a.peers[b].extra||{}:{}}),a.deletePeer(b))}),a.socket.on("user-connected",function(b){b!==a.userid&&a.onUserStatusChanged({userid:b,status:"online",extra:a.peers[b]?a.peers[b].extra||{}:{}})}),a.socket.on("closed-entire-session",function(b,c){a.leave(),a.onEntireSessionClosed({sessionid:b,userid:b,extra:c})}),a.socket.on("userid-already-taken",function(b,c){a.isInitiator=!1,a.userid=c,a.onUserIdAlreadyTaken(b,c)}),a.socket.on("logs",function(b){a.enableLogs&&console.debug("server-logs",b)}),a.socket.on("number-of-broadcast-viewers-updated",function(b){a.onNumberOfBroadcastViewersUpdated(b)})}function c(a){function b(b,c,e){var f={};a.attachStreams.forEach(function(a){f[a.streamid]={isAudio:!!a.isAudio,isVideo:!!a.isVideo,isScreen:!!a.isScreen}}),c.userPreferences.streamsToShare=f,d.onNegotiationNeeded({readyForOffer:!0,userPreferences:c.userPreferences},e)}function c(){a.fbr=new FileBufferReader,a.fbr.onProgress=function(b){a.onFileProgress(b)},a.fbr.onBegin=function(b){a.onFileStart(b)},a.fbr.onEnd=function(b){a.onFileEnd(b)}}var d=this,e=["getAllParticipants","getLength","selectFirst","streams","send","forEach"];a.peers={getLength:function(){var a=0;for(var b in this)e.indexOf(b)==-1&&a++;return a},selectFirst:function(){var a;for(var b in this)e.indexOf(b)==-1&&(a=this[b]);return a},getAllParticipants:function(a){var b=[];for(var c in this)e.indexOf(c)==-1&&c!=a&&b.push(c);return b},forEach:function(b){this.getAllParticipants().forEach(function(c){b(a.peers[c])})},send:function(b,c){var e=this;if(!l(b.size)&&!l(b.type))return void d.shareFile(b,c);if(!("text"===b.type||b instanceof ArrayBuffer||b instanceof DataView))return void TextSender.send({text:b,channel:this,connection:a,remoteUserId:c});if("text"===b.type&&(b=JSON.stringify(b)),c){var f=a.peers[c];if(f)return f.channels.length?void f.channels.forEach(function(a){a.send(b)}):(a.peers[c].createDataChannel(),a.renegotiate(c),void setTimeout(function(){e.send(b,c)},3e3))}this.getAllParticipants().forEach(function(c){return e[c].channels.length?void e[c].channels.forEach(function(a){a.send(b)}):(a.peers[c].createDataChannel(),a.renegotiate(c),void setTimeout(function(){e[c].channels.forEach(function(a){a.send(b)})},3e3))})}},this.uuid=a.userid,this.getLocalConfig=function(b,e,f){return f||(f={}),{streamsToShare:f.streamsToShare||{},rtcMultiConnection:a,connectionDescription:f.connectionDescription,userid:e,localPeerSdpConstraints:f.localPeerSdpConstraints,remotePeerSdpConstraints:f.remotePeerSdpConstraints,dontGetRemoteStream:!!f.dontGetRemoteStream,dontAttachLocalStream:!!f.dontAttachLocalStream,renegotiatingPeer:!!f.renegotiatingPeer,peerRef:f.peerRef,channels:f.channels||[],onLocalSdp:function(a){d.onNegotiationNeeded(a,e)},onLocalCandidate:function(b){b=O.processCandidates(a,b),b&&d.onNegotiationNeeded(b,e)},remoteSdp:b,onDataChannelMessage:function(b){if(!a.fbr&&a.enableFileSharing&&c(),"string"==typeof b||!a.enableFileSharing)return void d.onDataChannelMessage(b,e);var f=this;return b instanceof ArrayBuffer||b instanceof DataView?void a.fbr.convertToObject(b,function(a){f.onDataChannelMessage(a)}):b.readyForNextChunk?void a.fbr.getNextChunk(b.uuid,function(b,c){a.peers[e].channels.forEach(function(a){a.send(b)})},e):void a.fbr.addChunk(b,function(b){a.peers[e].peer.channel.send(b)})},onDataChannelError:function(a){d.onDataChannelError(a,e)},onDataChannelOpened:function(a){d.onDataChannelOpened(a,e)},onDataChannelClosed:function(a){d.onDataChannelClosed(a,e)},onRemoteStream:function(b){if(a.peers[e].streams.push(b),C&&window.PluginRTC){var c=document.createElement("video"),f=a.videosContainer;return f.insertBefore(c,f.firstChild),void setTimeout(function(){window.PluginRTC.attachMediaStream(c,b)},3e3)}d.onGettingRemoteMedia(b,e)},onRemoteStreamRemoved:function(a){d.onRemovingRemoteMedia(a,e)},onPeerStateChanged:function(a){d.onPeerStateChanged(a),"new"===a.iceConnectionState&&d.onNegotiationStarted(e,a),"connected"===a.iceConnectionState&&d.onNegotiationCompleted(e,a),a.iceConnectionState.search(/closed|failed/gi)!==-1&&(d.onUserLeft(e),d.disconnectWith(e))}}},this.createNewPeer=function(b,c){if(!(a.maxParticipantsAllowed<=a.getAllParticipants().length)){if(c=c||{},a.isInitiator&&a.session.audio&&"two-way"===a.session.audio&&!c.streamsToShare&&(c.isOneWay=!1,c.isDataOnly=!1,c.session=a.session),!c.isOneWay&&!c.isDataOnly)return c.isOneWay=!0,void this.onNegotiationNeeded({enableMedia:!0,userPreferences:c},b);c=a.setUserPreferences(c,b);var d=this.getLocalConfig(null,b,c);a.peers[b]=new p(d)}},this.createAnsweringPeer=function(b,c,d){d=a.setUserPreferences(d||{},c);var e=this.getLocalConfig(b,c,d);a.peers[c]=new p(e)},this.renegotiatePeer=function(b,c,d){if(!a.peers[b])return void(a.enableLogs&&console.error("This peer ("+b+") does not exists. Renegotiation skipped."));c||(c={}),c.renegotiatingPeer=!0,c.peerRef=a.peers[b].peer,c.channels=a.peers[b].channels;var e=this.getLocalConfig(d,b,c);
a.peers[b]=new p(e)},this.replaceTrack=function(b,c,d){if(!a.peers[c])throw"This peer ("+c+") does not exists.";var e=a.peers[c].peer;return e.getSenders&&"function"==typeof e.getSenders&&e.getSenders().length?void e.getSenders().forEach(function(e){d&&e.track instanceof VideoStreamTrack&&(a.peers[c].peer.lastVideoTrack=e.track,e.replaceTrack(b)),!d&&e.track instanceof AudioStreamTrack&&(a.peers[c].peer.lastAudioTrack=e.track,e.replaceTrack(b))}):(console.warn("RTPSender.replaceTrack is NOT supported."),void this.renegotiatePeer(c))},this.onNegotiationNeeded=function(a,b){},this.addNegotiatedMessage=function(c,e){function f(a){b(a,c,e)}if(c.type&&c.sdp)return"answer"==c.type&&a.peers[e]&&a.peers[e].addRemoteSdp(c),"offer"==c.type&&(c.renegotiatingPeer?this.renegotiatePeer(e,null,c):this.createAnsweringPeer(c,e)),void(a.enableLogs&&console.log("Remote peer's sdp:",c.sdp));if(c.candidate)return a.peers[e]&&a.peers[e].addRemoteCandidate(c),void(a.enableLogs&&console.log("Remote peer's candidate pairs:",c.candidate));if(c.enableMedia){if(a.attachStreams.length||a.dontCaptureUserMedia){var g={};return a.attachStreams.forEach(function(a){g[a.streamid]={isAudio:!!a.isAudio,isVideo:!!a.isVideo,isScreen:!!a.isScreen}}),c.userPreferences.streamsToShare=g,void d.onNegotiationNeeded({readyForOffer:!0,userPreferences:c.userPreferences},e)}var h={},i=c.userPreferences;i.localPeerSdpConstraints.OfferToReceiveAudio&&(h.audio=a.mediaConstraints.audio),i.localPeerSdpConstraints.OfferToReceiveVideo&&(h.video=a.mediaConstraints.video);var j=i.session||a.session;j.oneway&&j.audio&&"two-way"===j.audio&&(j={audio:!0}),(j.audio||j.video||j.screen)&&(j.screen?a.getScreenConstraints(function(b,c){a.invokeGetUserMedia({audio:!!m(a)&&n(c),video:c,isScreen:!0},!j.audio&&!j.video||m(a)?f:a.invokeGetUserMedia(null,f))}):(j.audio||j.video)&&a.invokeGetUserMedia(null,f,j))}c.readyForOffer&&a.onReadyForOffer(e,c.userPreferences)},this.connectNewParticipantWithAllBroadcasters=function(a,b,c){if(c=c.split("|-,-|"),c.length){var e=c[0];d.onNegotiationNeeded({newParticipant:a,userPreferences:b||!1},e),delete c[0];var f=[];c.forEach(function(a){a&&f.push(a)}),setTimeout(function(){d.connectNewParticipantWithAllBroadcasters(a,b,f.join("|-,-|"))},1e4)}},this.onGettingRemoteMedia=function(a,b){},this.onRemovingRemoteMedia=function(a,b){},this.onGettingLocalMedia=function(a){},this.onLocalMediaError=function(b,c){a.onMediaError(b,c)},this.shareFile=function(b,d){if(!a.enableFileSharing)throw'"connection.enableFileSharing" is false.';c(),a.fbr.readAsArrayBuffer(b,function(b){var c=a.getAllParticipants();d&&(c=[d]),c.forEach(function(c){a.fbr.getNextChunk(b,function(b){a.peers[c].channels.forEach(function(a){a.send(b)})},c)})},{userid:a.userid,chunkSize:x?15e3:a.chunkSize||0})};var f=new TextReceiver(a);this.onDataChannelMessage=function(b,c){f.receive(JSON.parse(b),c,a.peers[c]?a.peers[c].extra:{})},this.onDataChannelClosed=function(b,c){b.userid=c,b.extra=a.peers[c]?a.peers[c].extra:{},a.onclose(b)},this.onDataChannelError=function(b,c){b.userid=c,event.extra=a.peers[c]?a.peers[c].extra:{},a.onerror(b)},this.onDataChannelOpened=function(b,c){return a.peers[c].channels.length?void(a.peers[c].channels=[b]):(a.peers[c].channels.push(b),void a.onopen({userid:c,extra:a.peers[c]?a.peers[c].extra:{},channel:b}))},this.onPeerStateChanged=function(b){a.onPeerStateChanged(b)},this.onNegotiationStarted=function(a,b){},this.onNegotiationCompleted=function(a,b){},this.getRemoteStreams=function(b){return b=b||a.peers.getAllParticipants()[0],a.peers[b]?a.peers[b].streams:[]},this.isPluginRTC=a.isPluginRTC=C}function d(a,b,c){if("undefined"!=typeof CustomEvent){var d={arguments:c,__exposedProps__:c},e=new CustomEvent(b,d);a.dispatchEvent(e)}}function e(a,b){if(!a||!b)throw"Both arguments are required.";if(a.onspeaking&&a.onsilence){if("undefined"==typeof hark)throw"hark.js not found.";hark(b.stream,{onspeaking:function(){a.onspeaking(b)},onsilence:function(){a.onsilence(b)},onvolumechange:function(c,d){a.onvolumechange&&a.onvolumechange(merge({volume:c,threshold:d},b))}})}}function f(a,b){b.stream&&b.stream&&b.stream.addEventListener&&(b.stream.addEventListener("mute",function(c){c=a.streamEvents[b.streamid],c.session={audio:"audio"===c.muteType,video:"video"===c.muteType},a.onmute(c)},!1),b.stream.addEventListener("unmute",function(c){c=a.streamEvents[b.streamid],c.session={audio:"audio"===c.unmuteType,video:"video"===c.unmuteType},a.onunmute(c)},!1))}function g(){if(window.crypto&&window.crypto.getRandomValues&&navigator.userAgent.indexOf("Safari")===-1){for(var a=window.crypto.getRandomValues(new Uint32Array(3)),b="",c=0,d=a.length;c<d;c++)b+=a[c].toString(36);return b}return(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"")}function h(a,b,c){var d=!1;a.getVideoTracks&&!a.getVideoTracks().length&&(d=!0);var e=document.createElement(d?"audio":"video");if(C&&window.PluginRTC)return c.videosContainer.insertBefore(e,c.videosContainer.firstChild),void setTimeout(function(){window.PluginRTC.attachMediaStream(e,a),b(e)},1e3);if(e[x?"mozSrcObject":"src"]=x?a:window.URL.createObjectURL(a),e.controls=!0,x){var f="ended";"oninactive"in a&&(f="inactive"),e.addEventListener(f,function(){if(Q.remove(a.idInstance),"local"===a.type){R.onSyncNeeded(a.streamid,f),c.attachStreams.forEach(function(b,d){a.streamid===b.streamid&&delete c.attachStreams[d]});var b=[];c.attachStreams.forEach(function(a){a&&b.push(a)}),c.attachStreams=b;var d=c.streamEvents[a.streamid];if(d)return void c.onstreamended(d);this.parentNode&&this.parentNode.removeChild(this)}},!1)}e.play(),b(e)}function i(a,b){window.removeEventListener(a,b),window.addEventListener(a,b,!1)}function j(a){var b=[];return a.forEach(function(a){a&&b.push(a)}),b}function k(a){return!a.audio&&!a.video&&!a.screen&&a.data}function l(a){return"undefined"==typeof a}function m(a,b){return(!a.session.audio||"two-way"!==a.session.audio)&&(!(!x||b===!1)||!(!z||D<50)&&(typeof b===!0||!("undefined"!=typeof b||!a.session.audio||!a.session.screen||a.session.video)&&(b=!0,!0)))}function n(a){return!!x||!!z&&{mandatory:{chromeMediaSource:a.mandatory.chromeMediaSource,chromeMediaSourceId:a.mandatory.chromeMediaSourceId}}}function o(a){var b,c={OfferToReceiveAudio:!!a.OfferToReceiveAudio,OfferToReceiveVideo:!!a.OfferToReceiveVideo};return b={mandatory:c,optional:[{VoiceActivityDetection:!1}]},navigator.mozGetUserMedia&&F>34&&(b={OfferToReceiveAudio:!!a.OfferToReceiveAudio,OfferToReceiveVideo:!!a.OfferToReceiveVideo}),b}function p(a){function b(){return i.getLocalStreams()}function c(b){b.binaryType="arraybuffer",b.onmessage=function(b){a.onDataChannelMessage(b.data)},b.onopen=function(){a.onDataChannelOpened(b)},b.onerror=function(b){a.onDataChannelError(b)},b.onclose=function(b){a.onDataChannelClosed(b)},b.internalSend=b.send,b.send=function(a){"open"===b.readyState&&b.internalSend(a)},i.channel=b}function e(b){i[b](function(b){b.sdp=f.processSdp(b.sdp),i.setLocalDescription(b,function(){f.trickleIce&&a.onLocalSdp({type:b.type,sdp:b.sdp,remotePeerSdpConstraints:a.remotePeerSdpConstraints||!1,renegotiatingPeer:!!a.renegotiatingPeer||!1,connectionDescription:g.connectionDescription,dontGetRemoteStream:!!a.dontGetRemoteStream,extra:f?f.extra:{},streamsToShare:s,isFirefoxOffered:x})},function(a){f.enableLogs&&console.error("setLocalDescription error",a)})},function(a){f.enableLogs&&console.error("sdp-error",a)},I.sdpConstraints)}if(!H)throw"WebRTC 1.0 (RTCPeerConnection) API are NOT available in this browser.";var f=a.rtcMultiConnection;this.extra=a.remoteSdp?a.remoteSdp.extra:f.extra,this.userid=a.userid,this.streams=[],this.channels=a.channels||[],this.connectionDescription=a.connectionDescription;var g=this;a.remoteSdp&&(this.connectionDescription=a.remoteSdp.connectionDescription);var h={};I.sdpConstraints=o({OfferToReceiveAudio:!0,OfferToReceiveVideo:!0});var i,j=!!a.renegotiatingPeer;a.remoteSdp&&(j=!!a.remoteSdp.renegotiatingPeer);var k=[];if(f.attachStreams.forEach(function(a){a&&k.push(a)}),j)i=a.peerRef;else{var l="all";(f.candidates.turn||f.candidates.relay)&&(f.candidates.stun||f.candidates.reflexive||f.candidates.host||(l="relay")),i=new H(navigator.onLine?{iceServers:f.iceServers,iceTransports:l}:null,window.PluginRTC?null:f.optionalArgument)}i.onicecandidate=function(b){if(b.candidate)f.trickleIce&&a.onLocalCandidate({candidate:b.candidate.candidate,sdpMid:b.candidate.sdpMid,sdpMLineIndex:b.candidate.sdpMLineIndex});else if(!f.trickleIce){var c=i.localDescription;a.onLocalSdp({type:c.type,sdp:c.sdp,remotePeerSdpConstraints:a.remotePeerSdpConstraints||!1,renegotiatingPeer:!!a.renegotiatingPeer||!1,connectionDescription:g.connectionDescription,dontGetRemoteStream:!!a.dontGetRemoteStream,extra:f?f.extra:{},streamsToShare:s,isFirefoxOffered:x})}};var m=!x;a.remoteSdp&&a.remoteSdp.remotePeerSdpConstraints&&a.remoteSdp.remotePeerSdpConstraints.isFirefoxOffered&&(m=!0),k.forEach(function(c){a.remoteSdp&&a.remoteSdp.remotePeerSdpConstraints&&a.remoteSdp.remotePeerSdpConstraints.dontGetRemoteStream||a.dontAttachLocalStream||(c=f.beforeAddingStream(c),c&&(b().forEach&&b().forEach(function(a){c&&a.id==c.id&&(c=null)}),c&&i.addStream(c)))}),i.oniceconnectionstatechange=i.onsignalingstatechange=function(){var b=g.extra;f.peers[g.userid]&&(b=f.peers[g.userid].extra||b),i&&a.onPeerStateChanged({iceConnectionState:i.iceConnectionState,iceGatheringState:i.iceGatheringState,signalingState:i.signalingState,extra:b,userid:g.userid})};var n={OfferToReceiveAudio:!!k.length,OfferToReceiveVideo:!!k.length};a.localPeerSdpConstraints&&(n=a.localPeerSdpConstraints),I.sdpConstraints=o(n);var p,q="addstream";i.addEventListener(q,function(b){if(b.streams&&b.streams.length&&!b.stream){if(!p)return void(p=new G);if(b.streams.forEach(function(a){a.getVideoTracks().length&&p.addTrack(a.getVideoTracks()[0]),a.getAudioTracks().length&&p.addTrack(a.getAudioTracks()[0])}),b.stream=p,f.session.audio&&f.session.video&&(!p.getVideoTracks().length||!p.getAudioTracks().length))return;p=null}var c={};a.remoteSdp&&a.remoteSdp.streamsToShare?c=a.remoteSdp.streamsToShare:a.streamsToShare&&(c=a.streamsToShare);var e=c[b.stream.id];e&&(b.stream.isAudio=e.isAudio,b.stream.isVideo=e.isVideo,b.stream.isScreen=e.isScreen),b.stream.streamid=b.stream.id,b.stream.stop||(b.stream.stop=function(){if(x){var a="ended";"oninactive"in b.stream&&(a="inactive"),d(b.stream,a)}}),h[b.stream.id]=b.stream,a.onRemoteStream(b.stream)},!1),i.onremovestream=function(b){b.stream.streamid=b.stream.id,h[b.stream.id]&&delete h[b.stream.id],a.onRemoteStreamRemoved(b.stream)},this.addRemoteCandidate=function(a){i.addIceCandidate(new K(a))},this.addRemoteSdp=function(a,b){a.sdp=f.processSdp(a.sdp),i.setRemoteDescription(new J(a),b||function(){},function(b){f.enableLogs&&console.error(JSON.stringify(b,null,"\t"),"\n",a.type,a.sdp)})};var r=!0;a.remoteSdp&&(r=!1),this.createDataChannel=function(){var a=i.createDataChannel("sctp",{});c(a)},f.session.data!==!0||j||(r?this.createDataChannel():i.ondatachannel=function(a){var b=a.channel;c(b)}),a.remoteSdp&&(a.remoteSdp.remotePeerSdpConstraints&&(n=a.remoteSdp.remotePeerSdpConstraints),I.sdpConstraints=o(n),this.addRemoteSdp(a.remoteSdp,function(){e("createAnswer")})),"two-way"!=f.session.audio&&"two-way"!=f.session.video&&"two-way"!=f.session.screen||(I.sdpConstraints=o({OfferToReceiveAudio:"two-way"==f.session.audio||a.remoteSdp&&a.remoteSdp.remotePeerSdpConstraints&&a.remoteSdp.remotePeerSdpConstraints.OfferToReceiveAudio,OfferToReceiveVideo:"two-way"==f.session.video||"two-way"==f.session.screen||a.remoteSdp&&a.remoteSdp.remotePeerSdpConstraints&&a.remoteSdp.remotePeerSdpConstraints.OfferToReceiveAudio}));var s={};b().forEach&&b().forEach(function(a){s[a.streamid]={isAudio:!!a.isAudio,isVideo:!!a.isVideo,isScreen:!!a.isScreen}}),r&&e("createOffer"),i.nativeClose=i.close,i.close=function(){if(i){try{i.iceConnectionState.search(/closed|failed/gi)===-1&&i.getRemoteStreams().forEach(function(a){a.stop()}),i.nativeClose()}catch(a){}i=null,g.peer=null}},this.peer=i}function q(a,b){if(!N){if(!b)return q(a,!0);N=!0;var c=document.createElement("iframe");c.onload=function(){function b(c){c.data&&c.data.iceServers&&(a(c.data.iceServers),window.removeEventListener("message",b))}c.isLoaded=!0,i("message",b),c.contentWindow.postMessage("get-ice-servers","*")},c.src="https://cdn.webrtc-experiment.com/getIceServers/",c.style.display="none",(document.body||document.documentElement).appendChild(c)}}function r(a){var b="urls";C&&(b="url");var c={};return c[b]=a,c}function s(a,b,c){var d="urls";C&&(d="url");var e={username:b,credential:c};return e[d]=a,e}function t(){var a=[];return window.RMCExternalIceServers.forEach(function(b){b.urls||(b.urls=b.url),b.urls.search("stun|stuns")!==-1&&a.push(r(b.urls)),b.urls.search("turn|turns")!==-1&&a.push(s(b.urls,b.username,b.credential))}),a}function u(a,b){a.mandatory&&a.mandatory.chromeMediaSource?b.isScreen=!0:a.mozMediaSource||a.mediaSource?b.isScreen=!0:a.video?b.isVideo=!0:a.audio&&(b.isAudio=!0)}function v(a){function b(b,d){u(a.localMediaConstraints,b),a.onGettingLocalMedia(b,d);var e="ended";"oninactive"in b&&(e="inactive"),b.addEventListener(e,function(){delete Q.streams[c],Q.mutex=!1,Q.queueRequests.indexOf(a)&&(delete Q.queueRequests[Q.queueRequests.indexOf(a)],Q.queueRequests=j(Q.queueRequests))},!1),Q.streams[c]={stream:b},Q.mutex=!1,Q.queueRequests.length&&v(Q.queueRequests.shift())}if(Q.mutex===!0)return void Q.queueRequests.push(a);Q.mutex=!0;var c=JSON.stringify(a.localMediaConstraints);if(Q.streams[c])b(Q.streams[c].stream,!0);else{if(C&&window.PluginRTC){document.createElement("video");return void window.PluginRTC.getUserMedia({audio:!0,video:!0},function(a){a.streamid=a.id||g(),b(a)},function(a){})}var d=!!/BB10|BlackBerry/i.test(navigator.userAgent||"");if(d||"undefined"==typeof navigator.mediaDevices||"function"!=typeof navigator.mediaDevices.getUserMedia)return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,void navigator.getUserMedia(a.localMediaConstraints,function(a){a.streamid=a.streamid||a.id||g(),a.idInstance=c,b(a)},function(b){a.onLocalMediaError(b,a.localMediaConstraints)});navigator.mediaDevices.getUserMedia(a.localMediaConstraints).then(function(a){a.streamid=a.streamid||a.id||g(),a.idInstance=c,b(a)})["catch"](function(b){a.onLocalMediaError(b,a.localMediaConstraints)})}}var w=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,x="undefined"!=typeof window.InstallTrigger,y=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,z=!!window.chrome&&!w,A=!!document.documentMode,B=!!navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i);"undefined"!=typeof cordova&&(B=!0,z=!0),navigator&&navigator.userAgent&&navigator.userAgent.indexOf("Crosswalk")!==-1&&(B=!0,z=!0);var C=!B&&(y||A);C&&"undefined"!=typeof URL&&(URL.createObjectURL=function(){});var D=(!!(window.process&&"object"==typeof window.process&&window.process.versions&&window.process.versions["node-webkit"]),50),E=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);z&&E&&E[2]&&(D=parseInt(E[2],10));var F=50;E=navigator.userAgent.match(/Firefox\/(.*)/),x&&E&&E[1]&&(F=parseInt(E[1],10)),window.addEventListener||(window.addEventListener=function(a,b,c){a.attachEvent&&a.attachEvent("on"+b,c)}),window.attachEventListener=function(a,b,c,d){a.addEventListener(b,c,d)};var G=window.MediaStream;"undefined"==typeof G&&"undefined"!=typeof webkitMediaStream&&(G=webkitMediaStream),"undefined"!=typeof G&&("getVideoTracks"in G.prototype||(G.prototype.getVideoTracks=function(){if(!this.getTracks)return[];var a=[];return this.getTracks.forEach(function(b){b.kind.toString().indexOf("video")!==-1&&a.push(b)}),a},G.prototype.getAudioTracks=function(){if(!this.getTracks)return[];var a=[];return this.getTracks.forEach(function(b){b.kind.toString().indexOf("audio")!==-1&&a.push(b)}),a}),"stop"in G.prototype||(G.prototype.stop=function(){this.getAudioTracks().forEach(function(a){a.stop&&a.stop()}),this.getVideoTracks().forEach(function(a){a.stop&&a.stop()})})),function(){function a(){var a,b,c,d=(j.appVersion,j.userAgent),e=j.appName,f=""+parseFloat(j.appVersion),g=parseInt(j.appVersion,10);if(m){e="Opera";try{f=j.userAgent.split("OPR/")[1].split(" ")[0],g=f.split(".")[0]}catch(h){f="0.0.0.0",g=0}}else q?(b=d.indexOf("MSIE"),e="IE",f=d.substring(b+5)):p?(b=d.indexOf("Chrome"),e="Chrome",f=d.substring(b+7)):o?(b=d.indexOf("Safari"),e="Safari",f=d.substring(b+7),(b=d.indexOf("Version"))!==-1&&(f=d.substring(b+8))):n?(b=d.indexOf("Firefox"),e="Firefox",f=d.substring(b+8)):(a=d.lastIndexOf(" ")+1)<(b=d.lastIndexOf("/"))&&(e=d.substring(a,b),f=d.substring(b+1),e.toLowerCase()===e.toUpperCase()&&(e=j.appName));return l&&(e="Edge",f=parseInt(j.userAgent.match(/Edge\/(\d+).(\d+)$/)[2],10).toString()),(c=f.indexOf(";"))!==-1&&(f=f.substring(0,c)),(c=f.indexOf(" "))!==-1&&(f=f.substring(0,c)),g=parseInt(""+f,10),isNaN(g)&&(f=""+parseFloat(j.appVersion),g=parseInt(j.appVersion,10)),{fullVersion:f,version:g,name:e,isPrivateBrowsing:!1}}function b(a,b){var c=0,d=50,e=!1,f=window.setInterval(function(){a()&&(window.clearInterval(f),b(e)),c++>d&&(window.clearInterval(f),e=!0,b(e))},10)}function c(a){var b=a.toLowerCase();if(0===b.indexOf("msie")&&0===b.indexOf("trident"))return!1;var c=/(?:msie|rv:)\s?([\d\.]+)/.exec(b);return!!(c&&parseInt(c[1],10)>=10)}function d(a){var d;if(window.webkitRequestFileSystem)window.webkitRequestFileSystem(window.TEMPORARY,1,function(){d=!1},function(a){console.log(a),d=!0});else if(window.indexedDB&&/Firefox/.test(window.navigator.userAgent)){var e;try{e=window.indexedDB.open("test")}catch(f){d=!0}"undefined"==typeof d&&b(function(){return"done"===e.readyState},function(a){a||(d=!e.result)})}else if(c(window.navigator.userAgent)){d=!1;try{window.indexedDB||(d=!0)}catch(f){d=!0}}else if(window.localStorage&&/Safari/.test(window.navigator.userAgent)){try{window.localStorage.setItem("test",1)}catch(f){d=!0}"undefined"==typeof d&&(d=!1,window.localStorage.removeItem("test"))}b(function(){return"undefined"!=typeof d},function(b){a(d)})}function e(){var a="-",b=j.appVersion,c=j.userAgent,d=a,e=[{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var f in e){var g=e[f];if(g.r.test(c)){d=g.s;break}}var h=a;switch(/Windows/.test(d)&&(/Windows (.*)/.test(d)&&(h=/Windows (.*)/.exec(d)[1]),d="Windows"),d){case"Mac OS X":/Mac OS X (10[\.\_\d]+)/.test(c)&&(h=/Mac OS X (10[\.\_\d]+)/.exec(c)[1]);break;case"Android":/Android ([\.\_\d]+)/.test(c)&&(h=/Android ([\.\_\d]+)/.exec(c)[1]);break;case"iOS":/OS (\d+)_(\d+)_?(\d+)?/.test(c)&&(h=/OS (\d+)_(\d+)_?(\d+)?/.exec(b),h=h[1]+"."+h[2]+"."+(0|h[3]))}return{osName:d,osVersion:h}}function f(a){H.isWebRTCSupported&&(H.isORTCSupported||g(function(b){a(b.match(/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/)?"Local: "+b:"Public: "+b)}))}function g(a){function b(b){var d=/([0-9]{1,3}(\.[0-9]{1,3}){3})/,e=d.exec(b);if(!e)return void console.warn("Could not match IP address in",b);var f=e[1];void 0===c[f]&&a(f),c[f]=!0}var c={},d=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,e=!!window.webkitRTCPeerConnection;if(!d){var f=document.getElementById("iframe");if(!f)throw"NOTE: you need to have an iframe in the page right above the script tag.";var g=f.contentWindow;d=g.RTCPeerConnection||g.mozRTCPeerConnection||g.webkitRTCPeerConnection,e=!!g.webkitRTCPeerConnection}if(d){var h,i={optional:[{RtpDataChannels:!0}]};e&&(h={iceServers:[{urls:"stun:stun.services.mozilla.com"}]},"undefined"!=typeof H&&H.browser.isFirefox&&H.browser.version<=38&&(h[0]={url:h[0].urls}));var j=new d(h,i);j.onicecandidate=function(a){a.candidate&&b(a.candidate.candidate)},j.createDataChannel(""),j.createOffer(function(a){j.setLocalDescription(a,function(){},function(){})},function(){}),setTimeout(function(){var a=j.localDescription.sdp.split("\n");a.forEach(function(a){0===a.indexOf("a=candidate:")&&b(a)})},1e3)}}function h(a){return B?(!j.enumerateDevices&&window.MediaStreamTrack&&window.MediaStreamTrack.getSources&&(j.enumerateDevices=window.MediaStreamTrack.getSources.bind(window.MediaStreamTrack)),!j.enumerateDevices&&j.enumerateDevices&&(j.enumerateDevices=j.enumerateDevices.bind(j)),j.enumerateDevices?(x=[],y=[],z=[],A=[],void j.enumerateDevices(function(b){b.forEach(function(a){var b={};for(var c in a)b[c]=a[c];"audio"===b.kind&&(b.kind="audioinput"),"video"===b.kind&&(b.kind="videoinput");var d;x.forEach(function(a){a.id===b.id&&a.kind===b.kind&&(d=!0)}),d||(b.deviceId||(b.deviceId=b.id),b.id||(b.id=b.deviceId),b.label?("videoinput"!==b.kind||G||(G=!0),"audioinput"!==b.kind||F||(F=!0)):(b.label="Please invoke getUserMedia once.","https:"!==location.protocol&&document.domain.search&&document.domain.search(/localhost|127.0./g)===-1&&(b.label="HTTPs is required to get label of this "+b.kind+" device.")),"audioinput"===b.kind&&(C=!0,y.indexOf(b)===-1&&y.push(b)),"audiooutput"===b.kind&&(D=!0,z.indexOf(b)===-1&&z.push(b)),"videoinput"===b.kind&&(E=!0,A.indexOf(b)===-1&&A.push(b)),x.indexOf(b)===-1&&x.push(b))}),"undefined"!=typeof H&&(H.MediaDevices=x,H.hasMicrophone=C,H.hasSpeakers=D,H.hasWebcam=E,H.isWebsiteHasWebcamPermissions=G,H.isWebsiteHasMicrophonePermissions=F,H.audioInputDevices=y,H.audioOutputDevices=z,H.videoInputDevices=A),a&&a()})):void(a&&a())):void(a&&a())}var i="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";!function(a){"undefined"==typeof window&&("undefined"==typeof window&&"undefined"!=typeof global?(global.navigator={userAgent:i,getUserMedia:function(){}},a.window=global):"undefined"==typeof window,"undefined"==typeof document&&(a.document={},document.createElement=document.captureStream=document.mozCaptureStream=function(){return{}}),"undefined"==typeof location&&(a.location={protocol:"file:",href:"",hash:""}),"undefined"==typeof screen&&(a.screen={width:0,height:0}))}("undefined"!=typeof global?global:window);var j=window.navigator;"undefined"!=typeof j?("undefined"!=typeof j.webkitGetUserMedia&&(j.getUserMedia=j.webkitGetUserMedia),"undefined"!=typeof j.mozGetUserMedia&&(j.getUserMedia=j.mozGetUserMedia)):j={getUserMedia:function(){},userAgent:i};var k=!!/Android|webOS|iPhone|iPad|iPod|BB10|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(j.userAgent||""),l=!(j.userAgent.indexOf("Edge")===-1||!j.msSaveOrOpenBlob&&!j.msSaveBlob),m=!!window.opera||j.userAgent.indexOf(" OPR/")>=0,n="undefined"!=typeof window.InstallTrigger,o=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,p=!!window.chrome&&!m,q=!!document.documentMode&&!l,r={Android:function(){return j.userAgent.match(/Android/i)},BlackBerry:function(){return j.userAgent.match(/BlackBerry|BB10/i)},iOS:function(){return j.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return j.userAgent.match(/Opera Mini/i)},Windows:function(){return j.userAgent.match(/IEMobile/i)},any:function(){return r.Android()||r.BlackBerry()||r.iOS()||r.Opera()||r.Windows()},getOsName:function(){var a="Unknown OS";return r.Android()&&(a="Android"),r.BlackBerry()&&(a="BlackBerry"),r.iOS()&&(a="iOS"),r.Opera()&&(a="Opera Mini"),r.Windows()&&(a="Windows"),a}},s="Unknown OS",t="Unknown OS Version";if(r.any())s=r.getOsName();else{var u=e();s=u.osName,t=u.osVersion}var v=!1,w=!1;["captureStream","mozCaptureStream","webkitCaptureStream"].forEach(function(a){!v&&a in document.createElement("canvas")&&(v=!0),!w&&a in document.createElement("video")&&(w=!0)});var x=[],y=[],z=[],A=[];j.mediaDevices&&j.mediaDevices.enumerateDevices&&(j.enumerateDevices=function(a){j.mediaDevices.enumerateDevices().then(a)["catch"](function(){a([])})});var B=!1;"undefined"!=typeof L&&"getSources"in L?B=!0:j.mediaDevices&&j.mediaDevices.enumerateDevices&&(B=!0);var C=!1,D=!1,E=!1,F=!1,G=!1;h();var H=window.DetectRTC||{};H.browser=a(),d(function(a){H.browser.isPrivateBrowsing=!!a}),H.browser["is"+H.browser.name]=!0;var I=(!!(window.process&&"object"==typeof window.process&&window.process.versions&&window.process.versions["node-webkit"]),!1);["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","RTCIceGatherer"].forEach(function(a){I||a in window&&(I=!0)}),H.isWebRTCSupported=I,H.isORTCSupported="undefined"!=typeof RTCIceGatherer;var J=!1;H.browser.isChrome&&H.browser.version>=35?J=!0:H.browser.isFirefox&&H.browser.version>=34&&(J=!0),"https:"!==location.protocol&&(J=!1),H.isScreenCapturingSupported=J;var K={isSupported:!1,isCreateMediaStreamSourceSupported:!1};["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"].forEach(function(a){K.isSupported||a in window&&(K.isSupported=!0,"createMediaStreamSource"in window[a].prototype&&(K.isCreateMediaStreamSourceSupported=!0))}),H.isAudioContextSupported=K.isSupported,H.isCreateMediaStreamSourceSupported=K.isCreateMediaStreamSourceSupported;var M=!1;H.browser.isChrome&&H.browser.version>31&&(M=!0),H.isRtpDataChannelsSupported=M;var N=!1;H.browser.isFirefox&&H.browser.version>28?N=!0:H.browser.isChrome&&H.browser.version>25?N=!0:H.browser.isOpera&&H.browser.version>=11&&(N=!0),H.isSctpDataChannelsSupported=N,H.isMobileDevice=k;var O=!1;j.getUserMedia?O=!0:j.mediaDevices&&j.mediaDevices.getUserMedia&&(O=!0),H.browser.isChrome&&H.browser.version>=46&&"https:"!==location.protocol&&(H.isGetUserMediaSupported="Requires HTTPs"),H.isGetUserMediaSupported=O,H.osName=s,H.osVersion=t;var P="";if(screen.width){var Q=screen.width?screen.width:"",R=screen.height?screen.height:"";P+=""+Q+" x "+R}H.displayResolution=P,H.isCanvasSupportsStreamCapturing=v,H.isVideoSupportsStreamCapturing=w,H.DetectLocalIPAddress=f,H.isWebSocketsSupported="WebSocket"in window&&2===window.WebSocket.CLOSING,H.isWebSocketsBlocked=!H.isWebSocketsSupported,H.checkWebSocketsSupport=function(a){a=a||function(){};try{var b=new WebSocket("wss://echo.websocket.org:443/");b.onopen=function(){H.isWebSocketsBlocked=!1,a(),b.close(),b=null},b.onerror=function(){H.isWebSocketsBlocked=!0,a()}}catch(c){H.isWebSocketsBlocked=!0,a()}},H.load=function(a){a=a||function(){},h(a)},H.MediaDevices=x,H.hasMicrophone=C,H.hasSpeakers=D,H.hasWebcam=E,H.isWebsiteHasWebcamPermissions=G,H.isWebsiteHasMicrophonePermissions=F,H.audioInputDevices=y,H.audioOutputDevices=z,H.videoInputDevices=A;var S=!1;"setSinkId"in document.createElement("video")&&(S=!0),H.isSetSinkIdSupported=S;var T=!1;H.browser.isFirefox&&"undefined"!=typeof mozRTCPeerConnection?"getSenders"in mozRTCPeerConnection.prototype&&(T=!0):H.browser.isChrome&&"undefined"!=typeof webkitRTCPeerConnection&&"getSenders"in webkitRTCPeerConnection.prototype&&(T=!0),H.isRTPSenderReplaceTracksSupported=T;var U=!1;H.browser.isFirefox&&H.browser.version>38&&(U=!0),H.isRemoteStreamProcessingSupported=U;var V=!1;"undefined"!=typeof L&&"applyConstraints"in L.prototype&&(V=!0),H.isApplyConstraintsSupported=V;var W=!1;H.browser.isFirefox&&H.browser.version>=43&&(W=!0),H.isMultiMonitorScreenCapturingSupported=W,H.isPromisesSupported=!!("Promise"in window),"undefined"==typeof H&&(window.DetectRTC={});var X=window.MediaStream;"undefined"==typeof X&&"undefined"!=typeof webkitMediaStream&&(X=webkitMediaStream),"undefined"!=typeof X?H.MediaStream=Object.keys(X.prototype):H.MediaStream=!1,"undefined"!=typeof L?H.MediaStreamTrack=Object.keys(L.prototype):H.MediaStreamTrack=!1;var Y=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;"undefined"!=typeof Y?H.RTCPeerConnection=Object.keys(Y.prototype):H.RTCPeerConnection=!1,window.DetectRTC=H,"undefined"!=typeof module&&(module.exports=H),"function"==typeof define&&define.amd&&define("DetectRTC",[],function(){return H})}();var H,I={};"undefined"!=typeof window.RTCPeerConnection?H=window.RTCPeerConnection:"undefined"!=typeof mozRTCPeerConnection?H=mozRTCPeerConnection:"undefined"!=typeof webkitRTCPeerConnection&&(H=webkitRTCPeerConnection);var J=window.RTCSessionDescription||window.mozRTCSessionDescription,K=window.RTCIceCandidate||window.mozRTCIceCandidate,L=window.MediaStreamTrack;window.onPluginRTCInitialized=function(){L=window.PluginRTC.MediaStreamTrack,H=window.PluginRTC.RTCPeerConnection,K=window.PluginRTC.RTCIceCandidate,J=window.PluginRTC.RTCSessionDescription},"undefined"!=typeof window.PluginRTC&&window.onPluginRTCInitialized();var M=function(){function a(a){if(!a||"string"!=typeof a)throw"Invalid arguments.";return a=a.replace("a=rtpmap:100 VP8/90000\r\n",""),a=a.replace("a=rtpmap:101 VP9/90000\r\n",""),a=a.replace(/m=video ([0-9]+) RTP\/SAVPF ([0-9 ]*) 100/g,"m=video $1 RTP/SAVPF $2"),a=a.replace(/m=video ([0-9]+) RTP\/SAVPF ([0-9 ]*) 101/g,"m=video $1 RTP/SAVPF $2"),a=a.replace(/m=video ([0-9]+) RTP\/SAVPF 100([0-9 ]*)/g,"m=video $1 RTP/SAVPF$2"),a=a.replace(/m=video ([0-9]+) RTP\/SAVPF 101([0-9 ]*)/g,"m=video $1 RTP/SAVPF$2"),a=a.replace("a=rtcp-fb:120 nack\r\n",""),a=a.replace("a=rtcp-fb:120 nack pli\r\n",""),a=a.replace("a=rtcp-fb:120 ccm fir\r\n",""),a=a.replace("a=rtcp-fb:101 nack\r\n",""),a=a.replace("a=rtcp-fb:101 nack pli\r\n",""),a=a.replace("a=rtcp-fb:101 ccm fir\r\n","")}function b(a){if(!a||"string"!=typeof a)throw"Invalid arguments.";return a=a.replace("a=rtcp-fb:126 nack\r\n",""),a=a.replace("a=rtcp-fb:126 nack pli\r\n","a=rtcp-fb:126 pli\r\n"),a=a.replace("a=rtcp-fb:97 nack\r\n",""),a=a.replace("a=rtcp-fb:97 nack pli\r\n","a=rtcp-fb:97 pli\r\n")}function c(a,b){if(b&&b.getSenders&&b.getSenders().length){if(!a||"string"!=typeof a)throw"Invalid arguments.";b.getSenders().forEach(function(b){for(var c=b.getParameters(),d=0;d<c.codecs.length;d++)if(c.codecs[d].mimeType==a){c.codecs.unshift(c.codecs.splice(d,1));break}b.setParameters(c)})}}function d(a){return a.replace(/m=audio ([0-9]+) RTP\/SAVPF ([0-9 ]*)/g,"m=audio $1 RTP/SAVPF 9")}function e(a,b,c){return b?"undefined"!=typeof x&&x?a:m?a:(c&&(b.screen?b.screen<300&&console.warn("It seems that you are using wrong bandwidth value for screen. Screen sharing is expected to fail."):console.warn("It seems that you are not using bandwidth for screen. Screen sharing is expected to fail.")),b.screen&&c&&(a=a.replace(/b=AS([^\r\n]+\r\n)/g,""),a=a.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+b.screen+"\r\n")),(b.audio||b.video||b.data)&&(a=a.replace(/b=AS([^\r\n]+\r\n)/g,"")),b.audio&&(a=a.replace(/a=mid:audio\r\n/g,"a=mid:audio\r\nb=AS:"+b.audio+"\r\n")),b.video&&(a=a.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+(c?b.screen:b.video)+"\r\n")),a):a}function f(a,b,c){return g(a,0,-1,b,c)}function g(a,b,c,d,e){for(var f=c!==-1?c:a.length,g=b;g<f;++g)if(0===a[g].indexOf(d)&&(!e||a[g].toLowerCase().indexOf(e.toLowerCase())!==-1))return g;return null}function h(a){var b=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),c=a.match(b);return c&&2===c.length?c[1]:null}function i(a,b){if(m)return a;b=b||{};var c,d=b.min,e=b.max,g=a.split("\r\n"),i=f(g,"a=rtpmap","VP8/90000");if(i&&(c=h(g[i])),!c)return a;var j,k=f(g,"a=rtpmap","rtx/90000");if(k&&(j=h(g[k])),!k)return a;var l=f(g,"a=fmtp:"+j.toString());if(null!==l){var n="\r\n";
n+="a=fmtp:"+c+" x-google-min-bitrate="+(d||"228")+"; x-google-max-bitrate="+(e||"228"),g[l]=g[l].concat(n),a=g.join("\r\n")}return a}function j(a,b){if(m)return a;b=b||{};var c,d=a.split("\r\n"),e=f(d,"a=rtpmap","opus/48000");if(e&&(c=h(d[e])),!c)return a;var g=f(d,"a=fmtp:"+c.toString());if(null===g)return a;var i="";return i+="; stereo="+("undefined"!=typeof b.stereo?b.stereo:"1"),i+="; sprop-stereo="+("undefined"!=typeof b["sprop-stereo"]?b["sprop-stereo"]:"1"),"undefined"!=typeof b.maxaveragebitrate&&(i+="; maxaveragebitrate="+(b.maxaveragebitrate||1048576)),"undefined"!=typeof b.maxplaybackrate&&(i+="; maxplaybackrate="+(b.maxplaybackrate||1048576)),"undefined"!=typeof b.cbr&&(i+="; cbr="+("undefined"!=typeof b.cbr?b.cbr:"1")),"undefined"!=typeof b.useinbandfec&&(i+="; useinbandfec="+b.useinbandfec),"undefined"!=typeof b.usedtx&&(i+="; usedtx="+b.usedtx),"undefined"!=typeof b.maxptime&&(i+="\r\na=maxptime:"+b.maxptime),d[g]=d[g].concat(i),a=d.join("\r\n")}function k(a){return a.indexOf("SAVPF 100 101")===-1||a.indexOf("VP9/90000")===-1?a:a.replace("SAVPF 100 101","SAVPF 101 100")}function l(a){for(var b=a.split("\r\n"),c=null,d=0;d<b.length;d++)if(b[d].search("opus/48000")!==-1){var e=extractSdp(b[d],/:(\d+) opus\/48000/i);break}for(var d=0;d<b.length;d++)if(b[d].search("a=fmtp")!==-1){var f=extractSdp(b[d],/a=fmtp:(\d+)/);if(f===e){c=d;break}}return null===c?a:(b[c]=b[c].concat("; stereo=1; sprop-stereo=1"),a=b.join("\r\n"))}var m=!!navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i);return"undefined"!=typeof cordova&&(m=!0),navigator&&navigator.userAgent&&navigator.userAgent.indexOf("Crosswalk")!==-1&&(m=!0),{removeVPX:a,disableNACK:b,prioritize:c,removeNonG722:d,setApplicationSpecificBandwidth:function(a,b,c){return e(a,b,c)},setVideoBitrates:function(a,b){return i(a,b)},setOpusAttributes:function(a,b){return j(a,b)},preferVP9:k,forceStereoAudio:l}}();window.BandwidthHandler=M;var N,O=function(){function a(a,b){var c=b.candidate,d=a.candidates,e=d.stun,f=d.turn;if(l(d.reflexive)||(e=d.reflexive),l(d.relay)||(f=d.relay),(d.host||!c.match(/typ host/g))&&(f||!c.match(/typ relay/g))&&(e||!c.match(/typ srflx/g))){var g=a.iceProtocols;if((g.udp||!c.match(/ udp /g))&&(g.tcp||!c.match(/ tcp /g)))return a.enableLogs&&console.debug("Your candidate pairs:",c),{candidate:c,sdpMid:b.sdpMid,sdpMLineIndex:b.sdpMLineIndex}}}return{processCandidates:a}}();"undefined"!=typeof window.getExternalIceServers&&1==window.getExternalIceServers&&q(function(a){a&&a.length&&(window.RMCExternalIceServers=a,window.iceServersLoadCallback&&"function"==typeof window.iceServersLoadCallback&&window.iceServersLoadCallback(a))});var P=function(){function a(a){var b=[];return b.push(r("stun:stun.l.google.com:19302")),b.push(s("turn:webrtcweb.com:80","muazkh","muazkh")),b.push(s("turn:webrtcweb.com:443","muazkh","muazkh")),window.RMCExternalIceServers?b=b.concat(t()):"undefined"!=typeof window.getExternalIceServers&&1==window.getExternalIceServers&&(a.iceServers=b,window.iceServersLoadCallback=function(){a.iceServers=a.iceServers.concat(t())}),b}return{getIceServers:a}}(),Q={streams:[],mutex:!1,queueRequests:[],remove:function(a){this.mutex=!1;var b=this.streams[a];if(b){b=b.stream;var c=b.currentUserMediaRequestOptions;this.queueRequests.indexOf(c)&&(delete this.queueRequests[this.queueRequests.indexOf(c)],this.queueRequests=j(this.queueRequests)),this.streams[a].stream=null,delete this.streams[a]}}},R=function(){function a(a){if(a)return"string"==typeof a||"undefined"==typeof a?a:a.audio&&a.video?null:a.audio?"audio":a.video?"video":void 0}function b(b,e,f){function g(){if(f.streamEvents[b.streamid].mediaElement){var a=f.streamEvents[b.streamid].mediaElement;a.volume=0,c(200,5,function(){a.volume+=.2})}}if(b&&b.addEventListener){if("undefined"==typeof e||1==e){var h="ended";"oninactive"in b&&(h="inactive"),b.addEventListener(h,function(){R.onSyncNeeded(this.streamid,h)},!1)}b.mute=function(c,g){c=a(c),"undefined"!=typeof g&&(e=g),"undefined"!=typeof c&&"audio"!=c||b.getAudioTracks().forEach(function(a){a.enabled=!1,f.streamEvents[b.streamid].isAudioMuted=!0}),"undefined"!=typeof c&&"video"!=c||b.getVideoTracks().forEach(function(a){a.enabled=!1}),"undefined"!=typeof e&&1!=e||R.onSyncNeeded(b.streamid,"mute",c),f.streamEvents[b.streamid].muteType=c||"both",d(b,"mute",c)},b.unmute=function(c,h){c=a(c),"undefined"!=typeof h&&(e=h),g(),"undefined"!=typeof c&&"audio"!=c||b.getAudioTracks().forEach(function(a){a.enabled=!0,f.streamEvents[b.streamid].isAudioMuted=!1}),"undefined"!=typeof c&&"video"!=c||(b.getVideoTracks().forEach(function(a){a.enabled=!0}),"undefined"!=typeof c&&"video"==c&&f.streamEvents[b.streamid].isAudioMuted&&!function i(a){a||(a=0),a++,a<100&&f.streamEvents[b.streamid].isAudioMuted&&(b.mute("audio"),setTimeout(function(){i(a)},50))}()),"undefined"!=typeof e&&1!=e||R.onSyncNeeded(b.streamid,"unmute",c),f.streamEvents[b.streamid].unmuteType=c||"both",d(b,"unmute",c)}}}function c(a,b,d,e){e=(e||0)+1,e>=b||setTimeout(function(){d(),c(a,b,d,e)},a)}return{setHandlers:b,onSyncNeeded:function(a,b,c){}}}();window.RTCMultiConnection=a}();