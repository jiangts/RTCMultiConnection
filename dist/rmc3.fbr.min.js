// Last time updated: 2016-09-03 8:59:13 PM UTC

// _____________________
// RTCMultiConnection-v3

// Open-Sourced: https://github.com/muaz-khan/RTCMultiConnection

// --------------------------------------------------
// Muaz Khan     - www.MuazKhan.com
// MIT License   - www.WebRTC-Experiment.com/licence
// --------------------------------------------------

'use strict';

function FileBufferReader(){function a(b,c){if(null==b||"object"!=typeof b)return b;if(b.constructor!=Object&&b.constructor!=Array)return b;if(b.constructor==Date||b.constructor==RegExp||b.constructor==Function||b.constructor==String||b.constructor==Number||b.constructor==Boolean)return new b.constructor(b);c=c||new b.constructor;for(var d in b)c[d]="undefined"==typeof c[d]?a(b[d],null):c[d];return c}var b=this,c=new FileBufferReaderHelper;b.chunks={},b.users={},b.readAsArrayBuffer=function(a,d,e){if(!a.slice)return void console.warn("Not a real File object.",a);if(e=e||{userid:0},a.extra)if("string"==typeof a.extra)e.extra=a.extra;else for(var f in a.extra)e[f]=a.extra[f];e.fileName=a.name,a.uuid&&(e.fileUniqueId=a.uuid);var g={uuid:a.uuid||0,file:a,earlyCallback:d,extra:e,chunkSize:e.chunkSize};c.readAsArrayBuffer(b,g)},b.getNextChunk=function(c,d,e){var f=b.chunks[c];if(f){var g;"undefined"!=typeof e?(b.users[e+""]||(b.users[e+""]={fileUUID:c,userid:e,currentPosition:-1}),b.users[e+""].currentPosition++,g=b.users[e+""].currentPosition):(b.chunks[c].currentPosition++,g=b.chunks[c].currentPosition);var h=f[g];h&&(h=a(h),"undefined"!=typeof e&&(h.remoteUserId=e+""),h.start&&b.onBegin(h),h.end&&b.onEnd(h),b.onProgress(h),b.convertToArrayBuffer(h,function(a){return h.currentPosition==h.maxChunks?void d(a,!0):void d(a,!1)}))}};var d=new FileBufferReceiver(b);b.addChunk=function(a,c){return a?void d.receive(a,function(a){b.convertToArrayBuffer({readyForNextChunk:!0,uuid:a},c)}):void console.error("Chunk is missing.")},b.onBegin=function(){},b.onEnd=function(){},b.onProgress=function(){},b.convertToObject=FileConverter.ConvertToObject,b.convertToArrayBuffer=FileConverter.ConvertToArrayBuffer,b.setMultipleUsers=function(){}}function FileBufferReaderHelper(){function a(a){var b=URL.createObjectURL(new Blob([a.toString(),"this.onmessage =  function (e) {"+a.name+"(e.data);}"],{type:"application/javascript"}));return window.fileBufferWorker||(window.fileBufferWorker=new Worker(b)),window.fileBufferWorker}function b(a,b){function c(c,f,g){k=Math.ceil(f.byteLength/e);for(var h=0;h<k;h++){var i=h*e;n[m]=f.slice(i,Math.min(i+e,f.byteLength)),b({uuid:d.uuid,buffer:n[m],currentPosition:m,maxChunks:j,size:d.size,name:d.name||a.extra.fileName,lastModifiedDate:d.lastModifiedDate?d.lastModifiedDate.toString():"",type:d.type,extra:a.extra||a}),m++}m==j&&(l=!0),g()}b=b||function(a){postMessage(a)};var d=a.file;d.uuid||(d.uuid=a.fileUniqueId||(100*Math.random()).toString().replace(/\./g,""));var e=a.chunkSize||15e3,f=0,g=e,h=Math.floor(Math.min(1e8,g)/e),i=h*e,j=Math.ceil(d.size/e);d.maxChunks=j;var k,l,m=0,n=[];b({currentPosition:m,uuid:d.uuid,maxChunks:j,size:d.size,name:d.name||a.extra.fileName,type:d.type,lastModifiedDate:d.lastModifiedDate?d.lastModifiedDate.toString():"",start:!0,extra:a.extra||a,url:URL.createObjectURL(d)});var o,p=new FileReader;p.onloadend=function(e){e.target.readyState==FileReader.DONE&&c(d.name,e.target.result,function(){f++,(f+1)*i<d.size?(o=d.slice(f*i,(f+1)*i),p.readAsArrayBuffer(o)):f*i<d.size?(o=d.slice(f*i,d.size),p.readAsArrayBuffer(o)):b({currentPosition:m,uuid:d.uuid,maxChunks:j,size:d.size,name:d.name||a.extra.fileName,lastModifiedDate:d.lastModifiedDate?d.lastModifiedDate.toString():"",url:URL.createObjectURL(d),type:d.type,end:!0,extra:a.extra||a})})},m+=1,o=d.slice(f*i,(f+1)*i),p.readAsArrayBuffer(o)}var c=this;c.readAsArrayBuffer=function(c,d){function e(a){c.chunks[a.uuid]||(c.chunks[a.uuid]={currentPosition:-1}),d.extra=d.extra||{userid:0},a.userid=d.userid||d.extra.userid||0,a.extra=d.extra,c.chunks[a.uuid][a.currentPosition]=a,a.end&&f&&(f(a.uuid),f=null),a.maxChunks>5&&5==a.currentPosition&&f&&(f(a.uuid),f=null)}var f=d.earlyCallback;if(delete d.earlyCallback,navigator.mozGetUserMedia&&(window.___Worker=window.Worker,delete window.Worker),window.Worker&&"function"==typeof Worker){var g=a(b);g.onmessage=function(a){e(a.data)},g.postMessage(d)}else b(d,e),navigator.mozGetUserMedia&&(window.Worker=window.___Worker)}}function FileBufferReceiver(a){function b(f,g){if(!f.uuid)return void a.convertToObject(f,function(a){b(a)});if(f.start&&!d[f.uuid]&&(d[f.uuid]=[],e[f.uuid]&&(d[f.uuid].push(f.buffer),e[f.uuid].forEach(function(a){b(a,g)}),delete e[f.uuid]),a.onBegin&&a.onBegin(f)),!f.end&&f.buffer){if(!d[f.uuid])return e[f.uuid]||(e[f.uuid]=[]),void e[f.uuid].push(f);d[f.uuid].indexOf(f.buffer)==-1&&d[f.uuid].push(f.buffer)}if(f.end){for(var h=d[f.uuid],i=[],j=h.length,k=0;k<j;k++)h[k]&&i.push(h[k]);var l=new Blob(i,{type:f.type});l=c(l,f),l.url=URL.createObjectURL(l),l.uuid=f.uuid||l.extra.fileUniqueId,l.name=l.name||l.extra.fileName,l.size||console.error("Something went wrong. Blob Size is 0."),a.onEnd&&a.onEnd(l)}f.buffer&&a.onProgress&&a.onProgress(f),f.end||g(f.uuid)}function c(a,b){if(a||(a={}),!b)return a;for(var c in b)try{a[c]=b[c]}catch(d){}return a}var d={},e=[];this.receive=b}function merge(a,b){if(a||(a={}),!b)return a;for(var c in b)a[c]=b[c];return a}window.FileSelector=function(){function a(a,c){var d=document.createElement("input");d.type="file",c&&(d.multiple=!0),d.onchange=function(){return c?d.files.length?void a(d.files):void console.error("No file selected."):d.files[0]?(a(d.files[0]),void d.parentNode.removeChild(d)):void console.error("No file selected.")},d.style.display="none",(document.body||document.documentElement).appendChild(d),b(d)}function b(a){var b=new window.MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,button:0,buttons:0,mozInputSource:1});a.dispatchEvent(b)}var c=this;c.selectSingleFile=a,c.selectMultipleFiles=function(b){a(b,!0)}};var FileConverter={ConvertToArrayBuffer:function(a,b){binarize.pack(a,function(a){b(a.buffer)})},ConvertToObject:function(a,b){binarize.unpack(a,b)}};!function(a){var b=!1,c=!1,d=!0,e=Uint8Array.BYTES_PER_ELEMENT,f=Uint16Array.BYTES_PER_ELEMENT,g=Uint32Array.BYTES_PER_ELEMENT,h={NULL:0,UNDEFINED:1,STRING:2,NUMBER:3,BOOLEAN:4,ARRAY:5,OBJECT:6,INT8ARRAY:7,INT16ARRAY:8,INT32ARRAY:9,UINT8ARRAY:10,UINT16ARRAY:11,UINT32ARRAY:12,FLOAT32ARRAY:13,FLOAT64ARRAY:14,ARRAYBUFFER:15,BLOB:16,FILE:16,BUFFER:17};if(b)var i=["NULL","UNDEFINED","STRING","NUMBER","BOOLEAN","ARRAY","OBJECT","INT8ARRAY","INT16ARRAY","INT32ARRAY","UINT8ARRAY","UINT16ARRAY","UINT32ARRAY","FLOAT32ARRAY","FLOAT64ARRAY","ARRAYBUFFER","BLOB","BUFFER"];var j=[null,null,"Uint16","Float64","Uint8",null,null,"Int8","Int16","Int32","Uint8","Uint16","Uint32","Float32","Float64","Uint8","Uint8","Uint8"],k=function(a,b,d){var e=[],f=c,g=40;e[0]=[];for(var h=0;h<g;h++)e[0][h]=h<10?"0"+h.toString(10):h.toString(10);for(h=0;h<d;h++){var i=a.getUint8(b+h,f),j=~~(h/g)+1;"undefined"==typeof e[j]&&(e[j]=[]),e[j][h%g]=i<16?"0"+i.toString(16):i.toString(16)}for(console.log("%c"+e[0].join(" "),"font-weight: bold;"),h=1;h<e.length;h++)console.log(e[h].join(" "))},l=function(a){var b=void 0;if(void 0===a)b=h.UNDEFINED;else if(null===a)b=h.NULL;else{var c=a.constructor.name;if(void 0!==c)b=h[c.toUpperCase()];else switch(typeof a){case"string":b=h.STRING;break;case"number":b=h.NUMBER;break;case"boolean":b=h.BOOLEAN;break;case"object":a instanceof Array?b=h.ARRAY:a instanceof Int8Array?b=h.INT8ARRAY:a instanceof Int16Array?b=h.INT16ARRAY:a instanceof Int32Array?b=h.INT32ARRAY:a instanceof Uint8Array?b=h.UINT8ARRAY:a instanceof Uint16Array?b=h.UINT16ARRAY:a instanceof Uint32Array?b=h.UINT32ARRAY:a instanceof Float32Array?b=h.FLOAT32ARRAY:a instanceof Float64Array?b=h.FLOAT64ARRAY:a instanceof ArrayBuffer?b=h.ARRAYBUFFER:a instanceof Blob?b=h.BLOB:a instanceof Buffer?b=h.BUFFER:a instanceof Object&&(b=h.OBJECT)}}return b},m=function(d){var l=0,m=0,n=0,o=c,p=new ArrayBuffer(d[0].byte_length+d[0].header_size),q=new DataView(p);for(m=0;m<d.length;m++){var r=l,s=d[m].header_size,t=d[m].type,u=d[m].length,v=d[m].value,w=d[m].byte_length,x=j[t],y=null===x?0:a[x+"Array"].BYTES_PER_ELEMENT;switch(t===h.BUFFER?q.setUint8(l,h.BLOB,o):q.setUint8(l,t,o),l+=e,b&&console.info("Packing",t,i[t]),t!==h.ARRAY&&t!==h.OBJECT||(q.setUint16(l,u,o),l+=f,b&&console.info("Content Length",u)),q.setUint32(l,w,o),l+=g,b&&(console.info("Header Size",s,"bytes"),console.info("Byte Length",w,"bytes")),t){case h.NULL:case h.UNDEFINED:break;case h.STRING:for(b&&console.info('Actual Content %c"'+v+'"',"font-weight:bold;"),n=0;n<u;n++,l+=y)q.setUint16(l,v.charCodeAt(n),o);break;case h.NUMBER:case h.BOOLEAN:b&&console.info("%c"+v.toString(),"font-weight:bold;"),q["set"+x](l,v,o),l+=y;break;case h.INT8ARRAY:case h.INT16ARRAY:case h.INT32ARRAY:case h.UINT8ARRAY:case h.UINT16ARRAY:case h.UINT32ARRAY:case h.FLOAT32ARRAY:case h.FLOAT64ARRAY:var z=new Uint8Array(q.buffer,l,w);z.set(new Uint8Array(v.buffer)),l+=w;break;case h.ARRAYBUFFER:case h.BUFFER:var z=new Uint8Array(q.buffer,l,w);z.set(new Uint8Array(v)),l+=w;break;case h.BLOB:case h.ARRAY:case h.OBJECT:break;default:throw"TypeError: Unexpected type found."}b&&k(q,r,l-r)}return q},n=function(d,l){var m,o,p,q,r,s=0,t=c,u=l;m=d.getUint8(l,t),l+=e,b&&console.info("Unpacking",m,i[m]),m!==h.ARRAY&&m!==h.OBJECT||(o=d.getUint16(l,t),l+=f,b&&console.info("Content Length",o)),p=d.getUint32(l,t),l+=g,b&&console.info("Byte Length",p,"bytes");var v=j[m],w=null===v?0:a[v+"Array"].BYTES_PER_ELEMENT;switch(m){case h.NULL:case h.UNDEFINED:b&&k(d,u,l-u),q=null;break;case h.STRING:o=p/w;var x=[];for(s=0;s<o;s++){var y=d.getUint16(l,t);l+=w,x.push(String.fromCharCode(y))}q=x.join(""),b&&(console.info('Actual Content %c"'+q+'"',"font-weight:bold;"),k(d,u,l-u));break;case h.NUMBER:q=d.getFloat64(l,t),l+=w,b&&(console.info('Actual Content %c"'+q.toString()+'"',"font-weight:bold;"),k(d,u,l-u));break;case h.BOOLEAN:q=1===d.getUint8(l,t),l+=w,b&&(console.info('Actual Content %c"'+q.toString()+'"',"font-weight:bold;"),k(d,u,l-u));break;case h.INT8ARRAY:case h.INT16ARRAY:case h.INT32ARRAY:case h.UINT8ARRAY:case h.UINT16ARRAY:case h.UINT32ARRAY:case h.FLOAT32ARRAY:case h.FLOAT64ARRAY:case h.ARRAYBUFFER:r=d.buffer.slice(l,l+p),l+=p,q=m===h.ARRAYBUFFER?r:new a[v+"Array"](r),b&&k(d,u,l-u);break;case h.BLOB:if(b&&k(d,u,l-u),a.Blob){var z=n(d,l),A=n(d,z.cursor);l=A.cursor,q=new Blob([A.value],{type:z.value})}else r=d.buffer.slice(l,l+p),l+=p,q=new Buffer(r);break;case h.ARRAY:for(b&&k(d,u,l-u),q=[],s=0;s<o;s++)r=n(d,l),l=r.cursor,q.push(r.value);break;case h.OBJECT:for(b&&k(d,u,l-u),q={},s=0;s<o;s++){var B=n(d,l),C=n(d,B.cursor);l=C.cursor,q[B.value]=C.value}break;default:throw"TypeError: Type not supported."}return{value:q,cursor:l}},o=function(a,b){for(var c=a.length,d=[],e=0,f=0,g=0;g<a.length;g++)!function(g){p(a[g],function(a){if(d[g]=a,f+=a[0].header_size+a[0].byte_length,++e===c){for(var h=[],i=0;i<d.length;i++)h=h.concat(d[i]);b(h,f)}})}(g)},p=function(b,c){var d,i=[],k=1,m=e+g,n=0,p=0,q=b;switch(d=l(b),k=void 0===j[d]||null===j[d]?0:a[j[d]+"Array"].BYTES_PER_ELEMENT,d){case h.UNDEFINED:case h.NULL:break;case h.NUMBER:case h.BOOLEAN:n=k;break;case h.STRING:p=b.length,n+=p*k;break;case h.INT8ARRAY:case h.INT16ARRAY:case h.INT32ARRAY:case h.UINT8ARRAY:case h.UINT16ARRAY:case h.UINT32ARRAY:case h.FLOAT32ARRAY:case h.FLOAT64ARRAY:p=b.length,n+=p*k;break;case h.ARRAY:return void o(b,function(a,e){c([{type:d,length:b.length,header_size:m+f,byte_length:e,value:null}].concat(a))});case h.OBJECT:var r=[];for(var s in b)b.hasOwnProperty(s)&&(r.push(s),r.push(b[s]),p++);return void o(r,function(a,b){c([{type:d,length:p,header_size:m+f,byte_length:b,value:null}].concat(a))});case h.ARRAYBUFFER:n+=b.byteLength;break;case h.BLOB:var t=b.type,u=new FileReader;return u.onload=function(a){o([t,a.target.result],function(a,b){c([{type:d,length:p,header_size:m,byte_length:b,value:null}].concat(a))})},u.onerror=function(a){throw"FileReader Error: "+a},void u.readAsArrayBuffer(b);case h.BUFFER:n+=b.length;break;default:throw'TypeError: Type "'+b.constructor.name+'" not supported.'}c([{type:d,length:p,header_size:m,byte_length:n,value:q}].concat(i))},q=function(a,b){var c=a instanceof DataView?a:new DataView(a),d=n(c,0);return d.value};b&&(a.Test={BIG_ENDIAN:c,LITTLE_ENDIAN:d,Types:h,pack:m,unpack:n,serialize:p,deserialize:q});var r={pack:function(a,c){try{b&&console.info("%cPacking Start","font-weight: bold; color: red;",a),p(a,function(a){b&&console.info("Serialized Object",a),c(m(a))})}catch(d){throw d}},unpack:function(a,c){try{b&&console.info("%cUnpacking Start","font-weight: bold; color: red;",a);var d=q(a);b&&console.info("Deserialized Object",d),c(d)}catch(e){throw e}}};"undefined"!=typeof module&&module.exports?module.exports=r:a.binarize=r}("undefined"!=typeof global?global:this);